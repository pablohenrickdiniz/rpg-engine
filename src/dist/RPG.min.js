(function(l){var k=l.CE,c=k.CE;var h={calculate_final_position:function(y,E,D,B){var z={x:E,y:D,width:y.width,height:y.height,groups:["STEP"]};var A={x:E-y.x,y:D-y.y};var C=d.Globals.current_map._getCollideTree();var F=C.retrieve(z,"STEP");F.forEach(function(J){if(A.x>0&&J.x<(z.x+y.width)){z.x=J.x-y.width}else{if(A.x<0&&((J.x+J.width)>z.x)){z.x=J.x+J.width}}if(A.y>0&&J.y<(z.y+y.height)){z.y=J.y-y.height}else{if(A.y<0&&((J.y+J.height)>z.y)){z.y=J.y+J.height}}});if(z.x<0){z.x=0}else{if(z.x>d.Globals.current_map.getFullWidth()-32){z.x=d.Globals.current_map.getFullWidth()-32}else{if(A.x>0){z.x=Math.max(z.x,y.x)}else{if(A.x<0){z.x=Math.min(z.x,y.x)}else{z.x=y.x}}}}if(z.y<0){z.y=0}else{if(z.y>d.Globals.current_map.getFullHeight()-32){z.y=d.Globals.current_map.getFullHeight()-32}else{if(A.y>0){z.y=Math.max(z.y,y.y)}else{if(A.y<0){z.y=Math.min(z.y,y.y)}else{z.y=y.y}}}}var I=this;var H=I.distance({x:y.x,y:y.y},{x:E,y:D});var G=I.distance({x:y.x,y:y.y},{x:z.x,y:z.y});B=(B*G)/H;return{x:z.x,y:z.y,time:B}},distance:function(z,y){return Math.sqrt(Object.keys(z).reduce(function(A,B){return A+Math.pow(z[B]-y[B],2)},0))}};var d={Globals:{current_map:null,current_player:null,switches:[],variables:[],paused:true,start_time:null},_screen_width:600,_screen_height:400,_switches_callbacks:[],_canvas_engine:null,_key_reader:null,_interval:null,_running:false,_debug:false,_focused_event:null,_layers:{BG1:null,BG2:null,BG3:null,EV1:null,EV2:null,BG4:null,BG5:null,BG6:null,BG7:null,BG8:null,QUAD:null,menu1:null,menu2:null,menu3:null},_switchCallback:function(z,A){var y=d;if(y._switches_callbacks[z]===undefined){y._switches_callbacks[z]=[]}y._switches_callbacks[z].push(A)},initialize:function(z){var A=k.createEngine({width:d._screen_width,height:d._screen_height,container:z},s);var y=A.getKeyReader();d._layers.BG1=A.createLayer();d._layers.BG2=A.createLayer();d._layers.BG3=A.createLayer();d._layers.EV1=A.createLayer();d._layers.EV2=A.createLayer();d._layers.BG4=A.createLayer();d._layers.BG5=A.createLayer();d._layers.BG6=A.createLayer();d._layers.BG7=A.createLayer();d._layers.BG8=A.createLayer();d._layers.QUAD=A.createLayer();d._layers.menu1=A.createLayer({fixed:true});d._layers.menu2=A.createLayer({fixed:true});d._layers.menu3=A.createLayer({fixed:true});y.keydown("KEY_ESC",function(){if(!d._running){d.run()}else{d.end()}});y.keydown("KEY_ENTER",function(){d.actionEvents()});d._key_reader=y;d._canvas_engine=A},loadMap:function(A){d.Globals.current_map=A;var z=A.getFullWidth();var y=A.getFullHeight();d._layers.BG1.set({width:z,height:y});d._layers.BG2.set({width:z,height:y});d._layers.BG3.set({width:z,height:y});d._layers.EV1.set({width:z,height:y});d._layers.EV2.set({width:z,height:y});d._layers.BG4.set({width:z,height:y});d._layers.BG5.set({width:z,height:y});d._layers.BG6.set({width:z,height:y});d._layers.BG7.set({width:z,height:y});d._layers.BG8.set({width:z,height:y});d._layers.QUAD.set({width:z,height:y});d._canvas_engine.drawMap(A);A._getCollideTree().insert(d.Globals.current_player.bounds)},enableSwitch:function(z){var y=this;d.Globals.switches[z]=true;if(d._switches_callbacks[z]!==undefined){d._switches_callbacks[z].forEach(function(A){A()})}},disableSwitch:function(z){var y=this;d.Globals.switches[z]=false;if(d._switches_callbacks[z]!==undefined){d._switches_callbacks[z].forEach(function(A){A()})}},run:function(){d.Globals.start_time=(new Date()).getTime();console.log("game started");if(!d._running){d._running=true;d.step()}},end:function(){var y=this;d._running=false;l.cancelAnimationFrame(d._interval)},actionEvents:function(){var A=d.Globals.current_player;var z=d.Globals.current_map._getCollideTree();var D={x:A.bounds.x,y:A.bounds.y,width:A.bounds.width,height:A.bounds.height,groups:["ACTION_BUTTON"]};var C=A.direction;switch(C){case a.UP:D.y-=D.height;D.height*=2;break;case a.RIGHT:D.width*=2;break;case a.DOWN:D.height*=2;break;case a.LEFT:D.x-=D.width;D.width*=2;break}var B=z.retrieve(D,"ACTION_BUTTON");var y=d._key_reader;B.forEach(function(E){if(E._ref!==undefined){var F=E._ref;if(F.current_page!==undefined&&F.current_page!==null){var G=F.current_page;if(G.trigger===f.PLAYER_TOUCH){G.script()}else{if(G.trigger===f.ACTI0N_BUTTON&&y.isActive("KEY_ENTER")){G.script()}}}}})},stepPlayer:function(){var z=d.Globals.current_player;var y=d._key_reader;if(!z._moving){if(y.isActive("KEY_LEFT")){z.step(a.LEFT)}else{if(y.isActive("KEY_RIGHT")){z.step(a.RIGHT)}else{if(y.isActive("KEY_DOWN")){z.step(a.DOWN)}else{if(y.isActive("KEY_UP")){z.step(a.UP)}else{if(z.graphic!==null){var A="step_"+z.direction;z.graphic.animations[A].pauseToFrame(1);z._refreshed=false}}}}}}else{z._timeStepMove();z._refreshed=false}},stepEvents:function(){var y=this;var z=d.Globals.current_map.events;z.forEach(function(A){if(A.current_page!==null){if(!A._moving){if(A._follow!==null){A.look(A._follow);A.stepForward()}else{if(A.graphic!==null){var B="step_"+A.direction;A.graphic.animations[B].pauseToFrame(1)}}}else{A._timeStepMove();A._refreshed=false}}})},clearEvents:function(){var y=d.Globals.current_player;var D=d._canvas_engine;var F=d.Globals.current_map;D.clearGraphic(y.layer,y.graphic);var B=F.events;var A=B.length;for(var z=0;z<A;z++){var C=B[z];if(C.current_page!==null){var E=C.graphic;if(E!==null){D.clearGraphic(C.layer,E)}}}},drawEvents:function(){var y=d.Globals.current_player;var D=d._canvas_engine;var E=d.Globals.current_map;var B=E.events;var A=B.length;for(var z=0;z<A;z++){var C=B[z];if(C.current_page!==null){D.drawCharacter(C)}}D.drawCharacter(y)},step:function(){if(d._running){d._interval=l.requestAnimationFrame(function(){d.step()});d.stepPlayer();d.stepEvents();d.clearEvents();d.drawEvents();if(d._debug){d._canvas_engine.drawQuadTree(d.Globals.current_map._getCollideTree(),10)}}},getSeconds:function(){return parseInt(((new Date()).getTime()-d.Globals.start_time)/1000)},_focusOnEvent:function(z){var y=this;if(y._focused_event!==null){y._focused_event._camera_focus=false}z._camera_focus=true;y._focused_event=z}};var t=function(y,A,C){C=C===undefined?true:C;if(C){A.clear()}A.rect(y.bounds);if(C){var B=y.objects;B.forEach(function(D){A.rect(D)})}if(!y.isLeaf()){for(var z=0;z<y.nodes.length;z++){t(y.nodes[z],A,false)}}};var x=function(A,z){var y=this;y.bounds=A;y.parent=z;y.graphic=null;y.text=""};x.prototype.setGraphic=function(z){var y=this;y.graphic=z};x.prototype.setPosition=function(z,D){var A=this;switch(z){case v.LEFT:A.bounds.x=0;break;case v.CENTER:var C=A.parent.width-A.bounds.width*A.size;A.bounds.x=C/2;break;case v.RIGHT:A.bounds.x=A.parent.width-A.bounds.width*A.size}switch(D){case v.TOP:A.bounds.y=0;break;case v.CENTER:var B=A.parent.height-A.bounds.height*A.size;A.bounds.y=B/2;break;case v.BOTTOM:A.bounds.y=A.parent.height-A.bounds.height*A.size}};var b={top_bounds:{sx:144,sy:0,sWidth:16,sHeight:16},right_bounds:{sx:176,sy:16,sWidth:16,sHeight:16},bottom_bounds:{sx:144,sy:48,sWidth:16,sHeight:16},left_bounds:{sx:128,sy:16,sWidth:16,sHeight:16},background_bounds:{sWidth:128,sHeight:128},top_left_bounds:{sx:128,sy:0,sWidth:16,sHeight:16,dWidth:16,dHeight:16},top_right_bounds:{sx:176,sy:0,sWidth:16,sHeight:16,dWidth:16,dHeight:16},bottom_left_bounds:{sx:128,sy:48,sWidth:16,sHeight:16,dWidth:16,dHeight:16},bottom_right_bounds:{sx:176,sy:48,sWidth:16,sHeight:16,dWidth:16,dHeight:16},size:16,setBackgroundsBounds:function(z){var y=this;y.background_bounds=z},setTopBounds:function(z){var y=this;y.top_bounds=z},setRightBounds:function(z){var y=this;y.right_bounds=z},setBottomBounds:function(z){var y=this;y.bottom_bounds=z},setLeftBounds:function(z){var y=this;y.left_bounds=z},setTopLeftBounds:function(z){var y=this;y.top_left_bounds=z},setTopRightBounds:function(z){var y=this;y.top_right_bounds=z},setBottomRightBounds:function(z){var y=this;y.bottom_right_bounds=z},setBottomLeftBounds:function(z){var y=this;y.bottom_left_bounds=z},create:function(y,z){return new x(y,z)}};var s=function(z){var y=this;c.call(y,z)};s.prototype=Object.create(c.prototype);s.constructor=s;s.prototype.drawMap=function(C){var z=this;var y=C.getAreaInterval({x:0,y:0,width:C.getFullWidth(),height:C.getFullHeight()});for(var B=y.si;B<=y.ei;B++){for(var A=y.sj;A<=y.ej;A++){if(C.tiles[B]!==undefined&&C.tiles[B][A]!==undefined){C.tiles[B][A].forEach(function(E,D){if(z.layers[D]!==undefined){if(E!==null){z.layers[D].clearRect({x:E.dx,y:E.dy,width:E.dWidth,height:E.dHeight});z.layers[D].image(E)}}})}}}};s.prototype.drawQuadTree=function(y,A){var z=this;A=z.getLayer(A);t(y,A)};s.prototype.clearGraphic=function(y,B){var z=this;if(B!=null&&z.layers[y]!==undefined){var A=z.layers[y];A.clearRect({x:B.lx,y:B.ly,width:B.width,height:B.height})}};s.prototype.drawCharacter=function(F){if(F.graphic!==null){var D=F.layer;var I=this;if(I.layers[D]!==undefined){var E=I.layers[D];var z=F.bounds;var A=F.graphic;var B=F.getCurrentFrame();var H=z.x-(Math.max(A.width-32,0));var G=z.y-(Math.max(A.height-32,0));if(B!==undefined){var C={image:B.image,sx:B.sx,sy:B.sy,dx:H,dy:G,dWidth:B.dWidth,dHeight:B.dHeight,sWidth:B.sWidth,sHeight:B.sHeight};E.image(C);A.lx=H;A.ly=G;F._refreshed=true}}}};s.prototype.drawWindow=function(D){var G=D.parent;if(D.graphic!==null&&D.parent!==null){var z,J=b.size,K,I,C;var A=D.graphic;var F=D.bounds.x;var E=D.bounds.y;var B=D.bounds.width*J;var H=D.bounds.height*J;z=b.background_bounds;G.image({image:A,sWidth:z.sWidth,sHeight:z.sHeight,dx:F,dy:E,dWidth:B,dHeight:H,opacity:60});z=b.top_left_bounds;G.image({image:A,dx:F,dy:E,sx:z.sx,sy:z.sy,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight});z=b.top_right_bounds;G.image({image:A,dx:(F+B-J),dy:E,sx:z.sx,sy:z.sy,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight});z=b.bottom_right_bounds;G.image({image:A,dx:(F+B-J),dy:(E+H-J),sx:z.sx,sy:z.sy,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight});z=b.bottom_left_bounds;G.image({image:A,dx:F,dy:(E+H-J),sx:z.sx,sy:z.sy,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight});z=b.top_bounds;K=F+16;C=1;while(K<(F+B-16)){G.image({image:A,dx:K,dy:E,sx:z.sx+(C%2===0?16:0),sy:z.sy,dWidth:16,dHeight:16,sWidth:z.sWidth,sHeight:z.sHeight});K+=16;C++}z=b.right_bounds;I=E+16;C=1;while(I<(E+H-16)){G.image({image:A,dx:F+B-J,dy:I,sx:z.sx,sy:z.sy+(C%2==0?16:0),dWidth:16,dHeight:16,sWidth:z.sWidth,sHeight:z.sHeight});I+=J;C++}z=b.bottom_bounds;K=F+16;C=1;while(K<(F+B-16)){G.image({image:A,dx:K,dy:E+H-J,sx:z.sx+(C%2==0?16:0),sy:z.sy,dWidth:16,dHeight:16,sWidth:z.sWidth,sHeight:z.sHeight});K+=J;C++}z=b.left_bounds;I=E+16;C=1;while(I<(E+H-16)){G.image({image:A,dx:F,dy:I,sx:z.sx,sy:z.sy+(C%2==0?16:0),dWidth:16,dHeight:16,sWidth:z.sWidth,sHeight:z.sHeight});I+=J;C++}}};var u=function(z){var y=this;var B=z.frames===undefined?[]:z.frames;var A=parseFloat(z.fps);A=isNaN(A)||A<=0?3:A;y.name=z.name===undefined?"":z.name;y.fps=A;y.frames=B;y.start_time=null;y.end_time=null;y.running=false};u.prototype.getIndexFrame=function(){var y=this;var A=y.frames.length;var B=null;if(y.running){B=(new Date()).getTime()-y.start_time}else{B=y.end_time-y.start_time}var z=((B/1000)*y.fps)%A;z=z===0?A-1:z-1;return Math.abs(Math.ceil(z))};u.prototype.stop=function(){var y=this;y.pause()};u.prototype.execute=function(){var y=this;if(!y.running){y.start_time=(new Date()).getTime();y.running=true}};u.prototype.pause=function(){var y=this;if(y.running){y.end_time=(new Date()).getTime();y.running=false}};u.prototype.pauseToFrame=function(z){var y=this;if(y.frames[z]!==undefined){var A=(z/y.fps)*1000;y.end_time=y.start_time+A;y.running=false}};u.create=function(N){var B=parseFloat(N.fps);var M=parseInt(N.rows);var K=parseInt(N.cols);var I=parseInt(N.si);var E=parseInt(N.ei);var G=parseInt(N.sj);var C=parseInt(N.ej);M=isNaN(M)?1:M;K=isNaN(K)?1:K;B=isNaN(B)?K*2:B;I=isNaN(I)?0:I;E=isNaN(E)?M-1:E;G=isNaN(G)?0:G;C=isNaN(C)?K-1:C;var D=N.image;var z=D.width/K;var L=D.height/M;var y=N.name;var J=[];for(var H=I;H<=E&&H<M;H++){for(var F=G;F<=C&&F<K;F++){var A={image:D,sWidth:z,sHeight:L,dWidth:z,dHeight:L,sx:F*z,sy:H*L};J.push(A)}}return new u({name:"name",frames:J,fps:B})};var a={DOWN:"down",LEFT:"left",RIGHT:"right",UP:"up"};var r=function(z){var y=this;var C=z.image;var A=parseInt(z.rows);var B=parseInt(z.cols);A=isNaN(A)?1:A;B=isNaN(B)?1:B;y.image=C;y.rows=A;y.cols=B;y.width=C.width/y.cols;y.height=C.height/y.rows;y.animations={};y.lx=0;y.ly=0;y._initialize()};r.prototype._initialize=function(){var y=this;var z=y.image;y.animations.step_down=u.create({rows:4,cols:4,si:0,ei:0,image:z});y.animations.step_left=u.create({rows:4,cols:4,si:1,ei:1,image:z});y.animations.step_right=u.create({rows:4,cols:4,si:2,ei:2,image:z});y.animations.step_up=u.create({rows:4,cols:4,si:3,ei:3,image:z})};var g=function(z){var y=this;z=z===undefined?{}:z;y.initialize(z)};g.prototype.initialize=function(B){var A=this;var C=parseInt(B.speed);var z=parseInt(B.x);var D=parseInt(B.y);z=isNaN(z)?0:z;D=isNaN(D)?0:D;C=isNaN(C)?5:Math.abs(C);A.speed=C;A.graphic=null;A.bounds={x:z,y:D,width:32,height:32,_ref:A,groups:["EV"]};A.layer=2;A.direction=a.DOWN;A.h_speed=32;A.v_speed=32;A._moving=false;A._refreshed=false;A._start_moving_time=(new Date()).getTime();A._moving_time=0;A._moving_callback=null;A._start_position={x:z,y:D};A._end_position={x:z,y:D};A._camera_focus=false;A._follow=null};g.prototype.setPosition=function(z,B){var A=this;A.bounds.x=z;A.bounds.y=B;A.updateFocus()};g.prototype.moveTo=function(z,E,C,D){var A=this;var B=h.calculate_final_position(A.bounds,z,E,C);A._start_moving_time=(new Date()).getTime();A._moving_time=B.time;A._start_position={x:A.bounds.x,y:A.bounds.y};A._end_position={x:B.x,y:B.y};A._moving_callback=D};g.prototype._timeStepMove=function(){var A=this;var B=(new Date()).getTime();var E=B-A._start_moving_time;if(E>=A._moving_time){A.bounds.x=A._end_position.x;A.bounds.y=A._end_position.y;var G=A._moving_callback;A._moving_callback=null;if(typeof G==="function"){G()}}else{var D=(A._end_position.x-A._start_position.x);var C=(A._end_position.y-A._start_position.y);var z=A._start_position.x+((D*E)/A._moving_time);var F=A._start_position.y+((C*E)/A._moving_time);A.bounds.x=z;A.bounds.y=F;A.updateFocus();QuadTree.reInsert(A.bounds)}};g.prototype.updateFocus=function(){var H=this;if(H._camera_focus){var B=d._screen_width;var D=d._screen_height;var F=B/2;var C=D/2;var G=H.bounds.x;var E=H.bounds.y;var A=-G+F-(H.graphic.width/2);var z=-E+C-(H.graphic.height/2);d._canvas_engine.set({viewX:A,viewY:z})}};g.prototype.setGraphic=function(z){var y=this;y.graphic=z;z.lx=y.bounds.x;z.ly=y.bounds.y};g.prototype.getCurrentFrame=function(){var y=this;var A="step_"+y.direction;var z=y.graphic.animations[A];return z.frames[z.getIndexFrame()]};g.prototype.look=function(z){var y=this;switch(z){case a.UP:case a.DOWN:case a.RIGHT:case a.LEFT:y.direction=z;break;default:if(z instanceof g){var B=y.bounds.x-z.bounds.x;var A=y.bounds.y-z.bounds.y;y.direction=(B===A||B===0)?A<0?a.DOWN:a.UP:B<0?a.RIGHT:a.LEFT}}};g.prototype.step=function(F,A,D,B){var H=this;B=B===undefined?false:B;if(!H._moving||B){H._moving=true;var G=H.bounds.x;var E=H.bounds.y;var C=1000/H.speed;A=A===undefined?1:A;switch(F){case a.UP:E-=H.h_speed;break;case a.RIGHT:G+=H.h_speed;break;case a.LEFT:G-=H.h_speed;break;case a.DOWN:E+=H.h_speed;break}if(A<1){H._moving=false;if(typeof D==="function"){D()}}else{var z="step_"+F;H.graphic.animations[z].execute();H.direction=F;H.moveTo(G,E,C,function(){A--;H.step(F,A,D,true)})}}};g.prototype.stepForward=function(){var y=this;y.step(y.direction)};g.prototype.stepRandom=function(){var y=this;var B=Object.keys(a);var A=Math.floor(Math.random()*B.length);var z=B[A];y.step(a[z])};g.prototype.follow=function(z){var y=this;y._follow=z};g.prototype.unfollow=function(){var y=this;y._moving=false};var p={ON:"ON",OFF:"OFF"};var f={AUTO_RUN:"auto_run",PLAYER_TOUCH:"player_touch",ACTI0N_BUTTON:"action_button"};var n=function(z){var y=this;if(z===undefined||!(z.event instanceof w)){throw new Error("Page requires an event")}var A=z.graphic;y.conditions=z.conditions===undefined?{}:z.conditions;y.graphic=A instanceof r?A:null;y.script=z.script===undefined?function(){}:z.script;y.event=z.event;y.conditionsCound=0;y.trigger=z.trigger===undefined?f.AUTO_RUN:z.trigger;y._initializeConditions()};n.prototype._initializeConditions=function(){var J=this;var B=J.conditions.global_switch;var y=J.conditions.local_switch;var H=false;var F=false;var E=null;var z=null;var D=null;var G=null;var A=d.Globals.switches;var C=J.event.switches;if(B!==undefined&&B[0]!==undefined&&B[1]!==undefined){E=B[0];D=B[1];H=true}if(y!==undefined&&y[0]!==undefined&&y[1]!==undefined){z=y[0];G=y[1];F=true}var I=function(){var K=(!H||(H&&A[E]===true))&&(!F||(F&&C[z]===true));if(K){J.event.current_page=J}else{if(J.event.current_page===J){J.event.current_page=null}}};if(H){d._switchCallback(E,I)}if(F){J.event._switchCallback(z,I)}};n.prototype.setGraphic=function(z){var y=this;y.graphic=z};var w=function(z){var y=this;g.call(y,z);y._switches_callbacks=[];y.switches=[];y.current_page=null;y.pages=[];y.bounds.groups=["EV","ACTION_BUTTON"];Object.defineProperty(y,"graphic",{get:function(){if(y.current_page!==null&&y.current_page.graphic!==null){return y.current_page.graphic}return null}})};w.prototype=Object.create(g.prototype);w.constructor=w;w.prototype.getCurrentFrame=function(){var y=this;if(y.current_page!==null){var A="step_"+y.direction;var z=y.current_page.graphic.animations[A];return z.frames[z.getIndexFrame()]}return null};w.prototype.enableSwitch=function(z){var y=this;y.switches[z]=true;if(y._switches_callbacks[z]!==undefined){y._switches_callbacks[z].forEach(function(A){A()})}};w.prototype.disableSwitch=function(z){var y=this;y.switches[z]=false;if(y._switches_callbacks[z]!==undefined){y._switches_callbacks[z].forEach(function(A){A()})}};w.prototype._switchCallback=function(z,A){var y=this;if(y._switches_callbacks[z]===undefined){y._switches_callbacks[z]=[]}y._switches_callbacks[z].push(A)};w.prototype.addPage=function(z){var y=this;y.pages.push(z)};var e=function(A){var z=A.name;var B=A.graphic;var y=this;y.name=z;y.graphic=B};var q=function(z){var y=this;y.level=1;y.hp=100;y.mp=100;y.items=[];y.equiped_items=[];g.call(y,z)};q.prototype=Object.create(g.prototype);q.constructor=q;var i=function(B){var A=this;var E=parseInt(B.width);var y=parseInt(B.height);var z=parseInt(B.tile_w);var D=parseInt(B.tile_h);var C=B.events;E=isNaN(E)?10:E;y=isNaN(y)?10:y;z=isNaN(z)?32:z;D=isNaN(D)?32:D;A.width=E;A.height=y;A.tile_w=z;A.tile_h=D;A.tiles=[];A.events=[];A.parent=null;A._collideTree=null};i.prototype._getCollideTree=function(){var y=this;if(y._collideTree===null){y._collideTree=new QuadTree({x:0,y:0,width:y.getFullWidth(),height:y.getFullHeight()})}return y._collideTree};i.prototype.initializeCollision=function(){var z=this;var y=z._getCollideTree();z.eachTile(function(B){if(B.bounds!==undefined){var A=B.bounds;y.insert({x:B.dx+A.x,y:B.dy+A.y,width:A.width,height:A.height,groups:["MAP","EV","STEP"]})}})};i.prototype.getAreaInterval=function(I){var H=this;var F=parseInt(I.x);var E=parseInt(I.y);var z=parseInt(I.width);var G=parseInt(I.height);F=isNaN(F)?0:F;E=isNaN(E)?0:E;z=isNaN(z)?0:z;G=isNaN(G)?0:G;var D=parseInt(Math.floor(E/H.tile_h));var C=parseInt(Math.floor(F/H.tile_w));var B=parseInt(Math.floor((E+G)/H.tile_h));var A=parseInt(Math.floor((F+z)/H.tile_w));return{si:D,sj:C,ei:B,ej:A}};i.prototype.setTile=function(A,z,B){var y=this;if(y.tiles[A]===undefined){y.tiles[A]=[]}if(y.tiles[A][z]===undefined){y.tiles[A][z]=[]}y.tiles[A][z][B.layer]=B;return y};i.prototype.getTile=function(B,z,A){var y=this;if(y.tiles[B]!==undefined&&y.tiles[B][z]!==undefined&&y.tiles[B][z][A]!==undefined){return y.tiles[B][z][A]}return null};i.prototype.removeTile=function(B,z,A){var y=this;if(y.tiles[B]!==undefined&&y.tiles[B][z]!==undefined&&y.tiles[B][z][A]!==undefined){delete y.tiles[B][z][A]}};i.prototype.getFullWidth=function(){var y=this;return y.width*y.tile_w};i.prototype.getFullHeight=function(){var y=this;return y.height*y.tile_h};i.prototype.addEvent=function(z){var y=this;y.events.push(z);y._getCollideTree().insert(z.bounds)};i.prototype.eachTile=function(B){var y=this;for(var A=0;A<y.height;A++){for(var z=0;z<y.width;z++){if(y.tiles[A]!==undefined&&y.tiles[A][z]!==undefined){y.tiles[A][z].forEach(function(D,C){B(D,A,z,C)})}}}};var m={loadedImages:[],loadAll:function(y,z){j(y,[],z)},load:function(B,C){var A=this;var y=document.createElement("a");y.href=B;B=$(y).prop("href");if(A.loadedImages[B]===undefined){var z=new Image();z.crossOrigin="Anonymous";z.src=B;z.onload=function(){A.loadedImages[B]=z;C(z)}}else{C(A.loadedImages[B])}},toDataURL:function(y,C){var z=document.createElement("canvas");var A=z.getContext("2d");z.width=y.width;z.height=y.height;A.drawImage(y,0,0);var B=z.toDataURL();C(B);z=null}};var j=function(A,z,B){z=z===undefined?[]:z;if(A.length>0){var y=A.shift();m.load(y,function(C){z.push(C);j(A,z,B)})}else{if(typeof B==="function"){B(z)}}};var o={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(D,E,F){var B=this;E=E===undefined||!(E instanceof i)?new i():E;var z=parseInt(D.tile_w);var C=parseInt(D.tile_h);z=isNaN(z)?32:z;C=isNaN(C)?32:C;E.tile_w=z;E.tile_h=C;var y=D.tilesets!==undefined?D.tilesets:[];var A=D.tiles!==undefined?D.tiles:[];m.loadAll(y,function(G){A.forEach(function(I,H){if(I!==null){I.forEach(function(J,K){if(J!==null){J.forEach(function(M,L){if(M!==null){var N={};B.fields.forEach(function(Q,P){if(M[P]!==undefined){N[Q]=M[P]}});if(N.image!==undefined){var O=N.image;if(G[O]!==undefined){N.image=G[O]}}if(M[10]!==undefined){N.bounds={x:M[10],y:M[11],width:M[12],height:M[13]}}E.setTile(H,K,N)}else{E.removeTile(H,K)}})}})}});F(E)})}};var v={TOP:0,RIGHT:1,BOTTOM:2,LEFT:3,CENTER:4};d.Direction=a;d.Graphic=r;d.Character=g;d.CanvasEngine=s;d.Event=w;d.Page=n;d.Map=i;d.MapLoader=o;d.ImageLoader=m;d.Player=q;d.Trigger=f;d.Position=v;d.WindowBuilder=b;l.RPG=d})(window);