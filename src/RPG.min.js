(function(k){var j=k.CE,b=j.CE;var f={calculate_final_position:function(v,B,A,y){var w={x:B,y:A,width:v.width,height:v.height};var x={x:B-v.x,y:A-v.y};var z=c.Globals.current_map._colideTree;QuadTree.remove(v);z.insert(w);var C=QuadTree.getCollisions(w,"MAP");QuadTree.remove(w);z.insert(v);C.forEach(function(G){if(x.x>0&&G.x<(w.x+v.width)){w.x=G.x-v.width}else{if(x.x<0&&((G.x+G.width)>w.x)){w.x=G.x+G.width}}if(x.y>0&&G.y<(w.y+v.height)){w.y=G.y-v.height}else{if(x.y<0&&((G.y+G.height)>w.y)){w.y=G.y+G.height}}});if(w.x<0){w.x=0}else{if(w.x>c.Globals.current_map.getFullWidth()-32){w.x=c.Globals.current_map.getFullWidth()-32}else{if(x.x>0){w.x=Math.max(w.x,v.x)}else{if(x.x<0){w.x=Math.min(w.x,v.x)}else{w.x=v.x}}}}if(w.y<0){w.y=0}else{if(w.y>c.Globals.current_map.getFullHeight()-32){w.y=c.Globals.current_map.getFullHeight()-32}else{if(x.y>0){w.y=Math.max(w.y,v.y)}else{if(x.y<0){w.y=Math.min(w.y,v.y)}else{w.y=v.y}}}}var F=this;var E=F.distance({x:v.x,y:v.y},{x:B,y:A});var D=F.distance({x:v.x,y:v.y},{x:w.x,y:w.y});y=(y*D)/E;return{x:w.x,y:w.y,time:y}},distance:function(w,v){return Math.sqrt(Object.keys(w).reduce(function(x,y){return x+Math.pow(w[y]-v[y],2)},0))}};var c={Globals:{current_map:null,current_player:null,switches:[],variables:[],paused:true,start_time:null},_screen_width:600,_screen_height:600,_switches_callbacks:[],_canvas_engine:null,_key_reader:null,_interval:null,_running:false,_debug:false,_focused_event:null,_layers:{BG1:null,BG2:null,BG3:null,EV1:null,EV2:null,BG4:null,BG5:null,BG6:null,BG7:null,BG8:null,QUAD:null,menu1:null,menu2:null,menu3:null},_switchCallback:function(w,x){var v=c;if(v._switches_callbacks[w]===undefined){v._switches_callbacks[w]=[]}v._switches_callbacks[w].push(x)},initialize:function(w){var x=j.createEngine({width:c._screen_width,height:c._screen_height,container:w},r);var v=x.getKeyReader();c._layers.BG1=x.createLayer();c._layers.BG2=x.createLayer();c._layers.BG3=x.createLayer();c._layers.EV1=x.createLayer();c._layers.EV2=x.createLayer();c._layers.BG4=x.createLayer();c._layers.BG5=x.createLayer();c._layers.BG6=x.createLayer();c._layers.BG7=x.createLayer();c._layers.BG8=x.createLayer();c._layers.QUAD=x.createLayer();c._layers.menu1=x.createLayer();c._layers.menu2=x.createLayer();c._layers.menu3=x.createLayer();v.keydown("KEY_ESC",function(){if(!c._running){c.run()}else{c.end()}});v.keydown("KEY_ENTER",function(){c.actionEvents()});c._key_reader=v;c._canvas_engine=x},loadMap:function(x){c.Globals.current_map=x;var w=x.getFullWidth();var v=x.getFullHeight();c._layers.BG1.set({width:w,height:v});c._layers.BG2.set({width:w,height:v});c._layers.BG3.set({width:w,height:v});c._layers.EV1.set({width:w,height:v});c._layers.EV2.set({width:w,height:v});c._layers.BG4.set({width:w,height:v});c._layers.BG5.set({width:w,height:v});c._layers.BG6.set({width:w,height:v});c._layers.BG7.set({width:w,height:v});c._layers.BG8.set({width:w,height:v});c._layers.QUAD.set({width:w,height:v});c._canvas_engine.drawMap(x);x._colideTree.insert(c.Globals.current_player.bounds)},enableSwitch:function(w){var v=this;c.Globals.switches[w]=true;if(c._switches_callbacks[w]!==undefined){c._switches_callbacks[w].forEach(function(x){x()})}},disableSwitch:function(w){var v=this;c.Globals.switches[w]=false;if(c._switches_callbacks[w]!==undefined){c._switches_callbacks[w].forEach(function(x){x()})}},run:function(){c.Globals.start_time=(new Date()).getTime();console.log("game started");if(!c._running){c._running=true;c.step()}},end:function(){var v=this;c._running=false;k.cancelAnimationFrame(c._interval)},actionEvents:function(){var x=c.Globals.current_player;var w=c.Globals.current_map._colideTree;var A={x:x.bounds.x,y:x.bounds.y,width:x.bounds.width,height:x.bounds.height,groups:["EV"]};var z=x.direction;switch(z){case a.UP:A.y-=A.height;A.height*=2;break;case a.RIGHT:A.width*=2;break;case a.DOWN:A.height*=2;break;case a.LEFT:A.x-=A.width;A.width*=2;break}QuadTree.remove(x.bounds);w.insert(A);var y=QuadTree.getCollisions(A,"EV");QuadTree.remove(A);w.insert(x.bounds);var v=c._key_reader;y.forEach(function(B){if(B._ref!==undefined){var C=B._ref;if(C.current_page!==undefined&&C.current_page!==null){var D=C.current_page;if(D.trigger===d.PLAYER_TOUCH){D.script()}else{if(D.trigger===d.ACTI0N_BUTTON&&v.isActive("KEY_ENTER")){D.script()}}}}})},stepPlayer:function(){var w=c.Globals.current_player;var v=c._key_reader;if(!w._moving){if(v.isActive("KEY_LEFT")){w.step(a.LEFT)}else{if(v.isActive("KEY_RIGHT")){w.step(a.RIGHT)}else{if(v.isActive("KEY_DOWN")){w.step(a.DOWN)}else{if(v.isActive("KEY_UP")){w.step(a.UP)}else{var x="step_"+w.direction;w.graphic.animations[x].pauseToFrame(1);w._refreshed=false}}}}}else{w._timeStepMove();w._refreshed=false}},stepEvents:function(){var v=this;var w=c.Globals.current_map.events;w.forEach(function(x){if(x.current_page!==null){if(!x._moving){var y="step_"+x.direction;x.graphic.animations[y].pauseToFrame(1);x._refreshed=false}else{x._timeStepMove();x._refreshed=false}}})},clearEvents:function(){var v=c.Globals.current_player;var A=c._canvas_engine;var C=c.Globals.current_map;A.clearGraphic(v.layer,v.graphic);var y=C.events;var x=y.length;for(var w=0;w<x;w++){var z=y[w];if(z.current_page!==null){var B=z.graphic;if(B!==null){A.clearGraphic(z.layer,B)}}}},drawEvents:function(){var v=c.Globals.current_player;var A=c._canvas_engine;var B=c.Globals.current_map;var y=B.events;var x=y.length;for(var w=0;w<x;w++){var z=y[w];if(z.current_page!==null){A.drawEvent(z)}}A.drawCharacter(v)},step:function(){if(c._running){c._interval=k.requestAnimationFrame(function(){c.step()});c.stepPlayer();c.stepEvents();c.clearEvents();c.drawEvents();if(c._debug){c._canvas_engine.drawQuadTree(c.Globals.current_map._colideTree,10)}}},getSeconds:function(){return parseInt(((new Date()).getTime()-c.Globals.start_time)/1000)},_focusOnEvent:function(w){var v=this;if(v._focused_event!==null){v._focused_event._camera_focus=false}w._camera_focus=true;v._focused_event=w}};var s=function(v,x,z){z=z===undefined?true:z;if(z){x.clear()}x.rect(v.bounds);if(z){var y=v.objects;y.forEach(function(A){x.rect(A)})}if(!v.isLeaf()){for(var w=0;w<v.nodes.length;w++){s(v.nodes[w],x,false)}}};var r=function(w){var v=this;b.call(v,w)};r.prototype=Object.create(b.prototype);r.constructor=r;r.prototype.drawMap=function(z){var w=this;var v=z.getAreaInterval({x:0,y:0,width:z.getFullWidth(),height:z.getFullHeight()});for(var y=v.si;y<=v.ei;y++){for(var x=v.sj;x<=v.ej;x++){if(z.tiles[y]!==undefined&&z.tiles[y][x]!==undefined){z.tiles[y][x].forEach(function(B,A){if(w.layers[A]!==undefined){if(B!==null){w.layers[A].clearRect({x:B.dx,y:B.dy,width:B.dWidth,height:B.dHeight});w.layers[A].image(B)}}})}}}};r.prototype.drawQuadTree=function(v,x){var w=this;x=w.getLayer(x);s(v,x)};r.prototype.drawEvent=function(z){var w=z.current_page.graphic;if(w!==null){var C=z.layer;var G=this;if(G.layers[C]!==undefined){var D=G.layers[C];var v=z.bounds;var A=z.getCurrentFrame();var F=v.x-(Math.max(w.width-32,0));var E=v.y-(Math.max(w.height-32,0));if(A!==undefined){var B={image:A.image,sx:A.sx,sy:A.sy,dx:F,dy:E,dWidth:A.dWidth,dHeight:A.dHeight,sWidth:A.sWidth,sHeight:A.sHeight};D.image(B);w.lx=F;w.ly=E;z._refreshed=true}}}};r.prototype.clearGraphic=function(v,y){var w=this;if(w.layers[v]!==undefined){var x=w.layers[v];x.clearRect({x:y.lx,y:y.ly,width:y.width,height:y.height})}};r.prototype.drawCharacter=function(D){if(D.graphic!==null){var B=D.layer;var G=this;if(G.layers[B]!==undefined){var C=G.layers[B];var v=D.bounds;var w=D.graphic;var z=D.getCurrentFrame();var F=v.x-(Math.max(w.width-32,0));var E=v.y-(Math.max(w.height-32,0));if(z!==undefined){var A={image:z.image,sx:z.sx,sy:z.sy,dx:F,dy:E,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight};C.image(A);w.lx=F;w.ly=E;D._refreshed=true}}}};var t=function(w){var v=this;var y=w.frames===undefined?[]:w.frames;var x=parseFloat(w.fps);x=isNaN(x)||x<=0?3:x;v.name=w.name===undefined?"":w.name;v.fps=x;v.frames=y;v.start_time=null;v.end_time=null;v.running=false};t.prototype.getIndexFrame=function(){var v=this;var x=v.frames.length;var y=null;if(v.running){y=(new Date()).getTime()-v.start_time}else{y=v.end_time-v.start_time}var w=((y/1000)*v.fps)%x;w=w===0?x-1:w-1;return Math.abs(Math.ceil(w))};t.prototype.stop=function(){var v=this;v.pause()};t.prototype.execute=function(){var v=this;if(!v.running){v.start_time=(new Date()).getTime();v.running=true}};t.prototype.pause=function(){var v=this;if(v.running){v.end_time=(new Date()).getTime();v.running=false}};t.prototype.pauseToFrame=function(w){var v=this;if(v.frames[w]!==undefined){var x=(w/v.fps)*1000;v.end_time=v.start_time+x;v.running=false}};t.create=function(K){var y=parseFloat(K.fps);var J=parseInt(K.rows);var H=parseInt(K.cols);var F=parseInt(K.si);var B=parseInt(K.ei);var D=parseInt(K.sj);var z=parseInt(K.ej);J=isNaN(J)?1:J;H=isNaN(H)?1:H;y=isNaN(y)?H*2:y;F=isNaN(F)?0:F;B=isNaN(B)?J-1:B;D=isNaN(D)?0:D;z=isNaN(z)?H-1:z;var A=K.image;var w=A.width/H;var I=A.height/J;var v=K.name;var G=[];for(var E=F;E<=B&&E<J;E++){for(var C=D;C<=z&&C<H;C++){var x={image:A,sWidth:w,sHeight:I,dWidth:w,dHeight:I,sx:C*w,sy:E*I};G.push(x)}}return new t({name:"name",frames:G,fps:y})};var a={DOWN:"down",LEFT:"left",RIGHT:"right",UP:"up"};var p=function(w){var v=this;var z=w.image;var x=parseInt(w.rows);var y=parseInt(w.cols);x=isNaN(x)?1:x;y=isNaN(y)?1:y;v.image=z;v.rows=x;v.cols=y;v.width=z.width/v.cols;v.height=z.height/v.rows;v.animations={};v.lx=0;v.ly=0;v._initialize()};p.prototype._initialize=function(){var v=this;var w=v.image;v.animations.step_down=t.create({rows:4,cols:4,si:0,ei:0,image:w});v.animations.step_left=t.create({rows:4,cols:4,si:1,ei:1,image:w});v.animations.step_right=t.create({rows:4,cols:4,si:2,ei:2,image:w});v.animations.step_up=t.create({rows:4,cols:4,si:3,ei:3,image:w})};var e=function(w){var v=this;w=w===undefined?{}:w;v.initialize(w)};e.prototype.initialize=function(z){var w=this;var A=parseInt(z.speed);var v=parseInt(z.x);var B=parseInt(z.y);v=isNaN(v)?0:v;B=isNaN(B)?0:B;A=isNaN(A)?5:Math.abs(A);w.speed=A;w.graphic=null;w.bounds={x:v,y:B,width:32,height:32,_ref:w,groups:["EV","default"]};w.layer=2;w.direction=a.DOWN;w.h_speed=32;w.v_speed=32;w._moving=false;w._refreshed=false;w._start_moving_time=(new Date()).getTime();w._moving_time=0;w._moving_callback=null;w._start_position={x:v,y:B};w._end_position={x:v,y:B};w._camera_focus=false};e.prototype.setPosition=function(v,z){var w=this;w.bounds.x=v;w.bounds.y=z;w.updateFocus()};e.prototype.moveTo=function(v,C,A,B){var w=this;var z=f.calculate_final_position(w.bounds,v,C,A);w._start_moving_time=(new Date()).getTime();w._moving_time=z.time;w._start_position={x:w.bounds.x,y:w.bounds.y};w._end_position={x:z.x,y:z.y};w._moving_callback=B};e.prototype._timeStepMove=function(){var w=this;var z=(new Date()).getTime();var C=z-w._start_moving_time;if(C>=w._moving_time){w.bounds.x=w._end_position.x;w.bounds.y=w._end_position.y;var E=w._moving_callback;w._moving_callback=null;if(typeof E==="function"){E()}}else{var B=(w._end_position.x-w._start_position.x);var A=(w._end_position.y-w._start_position.y);var v=w._start_position.x+((B*C)/w._moving_time);var D=w._start_position.y+((A*C)/w._moving_time);w.bounds.x=v;w.bounds.y=D;w.updateFocus();QuadTree.reInsert(w.bounds)}};e.prototype.updateFocus=function(){var F=this;if(F._camera_focus){var z=c._screen_width;var B=c._screen_height;var D=z/2;var A=B/2;var E=F.bounds.x;var C=F.bounds.y;var w=-E+D-(F.graphic.width/2);var v=-C+A-(F.graphic.height/2);c._canvas_engine.set({viewX:w,viewY:v})}};e.prototype.setGraphic=function(w){var v=this;v.graphic=w;w.lx=v.bounds.x;w.ly=v.bounds.y};e.prototype.getCurrentFrame=function(){var v=this;var x="step_"+v.direction;var w=v.graphic.animations[x];return w.frames[w.getIndexFrame()]};e.prototype.step=function(D,w,B,z){var F=this;z=z===undefined?false:z;if(!F._moving||z){F._moving=true;var E=F.bounds.x;var C=F.bounds.y;var A=1000/F.speed;w=w===undefined?1:w;switch(D){case a.UP:C-=F.h_speed;break;case a.RIGHT:E+=F.h_speed;break;case a.LEFT:E-=F.h_speed;break;case a.DOWN:C+=F.h_speed;break}if(w<1){F._moving=false;if(typeof B==="function"){B()}}else{var v="step_"+D;F.graphic.animations[v].execute();F.direction=D;F.moveTo(E,C,A,function(){w--;F.step(D,w,B,true)})}}};e.prototype.stepForward=function(){var v=this;v.step(v.direction)};e.prototype.stepRandom=function(){var v=this;var y=Object.keys(a);var x=Math.floor(Math.random()*y.length);var w=y[x];v.step(a[w])};var o={ON:"ON",OFF:"OFF"};var d={AUTO_RUN:"auto_run",PLAYER_TOUCH:"player_touch",ACTI0N_BUTTON:"action_button"};var m=function(w){var v=this;if(w===undefined||!(w.event instanceof u)){throw new Error("Page requires an event")}var x=w.graphic;v.conditions=w.conditions===undefined?{}:w.conditions;v.graphic=x instanceof p?x:null;v.script=w.script===undefined?function(){}:w.script;v.event=w.event;v.conditionsCound=0;v.trigger=w.trigger===undefined?d.AUTO_RUN:w.trigger;v._initializeConditions()};m.prototype._initializeConditions=function(){var G=this;var y=G.conditions.global_switch;var v=G.conditions.local_switch;var E=false;var C=false;var B=null;var w=null;var A=null;var D=null;var x=c.Globals.switches;var z=G.event.switches;if(y!==undefined&&y[0]!==undefined&&y[1]!==undefined){B=y[0];A=y[1];E=true}if(v!==undefined&&v[0]!==undefined&&v[1]!==undefined){w=v[0];D=v[1];C=true}var F=function(){var H=(!E||(E&&x[B]===true))&&(!C||(C&&z[w]===true));if(H){G.event.current_page=G}else{if(G.event.current_page===G){G.event.current_page=null}}};if(E){c._switchCallback(B,F)}if(C){G.event._switchCallback(w,F)}};m.prototype._initializeTrigger=function(){};m.prototype.setGraphic=function(w){var v=this;v.graphic=w};var u=function(w){var v=this;e.call(v,w);v._switches_callbacks=[];v.switches=[];v.current_page=null;v.pages=[];v.bounds.groups=["EV","default"];Object.defineProperty(v,"graphic",{get:function(){if(v.current_page!==null&&v.current_page.graphic!==null){return v.current_page.graphic}return null}})};u.prototype=Object.create(e.prototype);u.constructor=u;u.prototype.getCurrentFrame=function(){var v=this;if(v.current_page!==null){var x="step_"+v.direction;var w=v.current_page.graphic.animations[x];return w.frames[w.getIndexFrame()]}return null};u.prototype.enableSwitch=function(w){var v=this;v.switches[w]=true;if(v._switches_callbacks[w]!==undefined){v._switches_callbacks[w].forEach(function(x){x()})}};u.prototype.disableSwitch=function(w){var v=this;v.switches[w]=false;if(v._switches_callbacks[w]!==undefined){v._switches_callbacks[w].forEach(function(x){x()})}};u.prototype._switchCallback=function(w,x){var v=this;if(v._switches_callbacks[w]===undefined){v._switches_callbacks[w]=[]}v._switches_callbacks[w].push(x)};u.prototype.addPage=function(w){var v=this;v.pages.push(w)};var q=function(w){var v=this;v.level=1;v.hp=100;v.mp=100;v.items=[];v.equiped_items=[];e.call(v,w)};q.prototype=Object.create(e.prototype);q.constructor=q;var g=function(y){var x=this;var B=parseInt(y.width);var v=parseInt(y.height);var w=parseInt(y.tile_w);var A=parseInt(y.tile_h);var z=y.events;B=isNaN(B)?10:B;v=isNaN(v)?10:v;w=isNaN(w)?32:w;A=isNaN(A)?32:A;x.width=B;x.height=v;x.tile_w=w;x.tile_h=A;x.tiles=[];x.events=[];x.parent=null;x._colideTree=null;x.colision=[]};g.prototype.initializeColision=function(){var v=this;v._colideTree=new QuadTree({x:0,y:0,width:v.getFullWidth(),height:v.getFullHeight()});var A=v.colision.length;for(var y=0;y<A;y++){var z=v.colision[y].length;for(var x=0;x<z;x++){var w=v.colision[y][x];if(w===true){v._colideTree.insert({x:x*v.tile_w,y:y*v.tile_h,width:v.tile_w,height:v.tile_h,groups:["MAP","EV"]})}}}};g.prototype.getAreaInterval=function(G){var F=this;var D=parseInt(G.x);var C=parseInt(G.y);var v=parseInt(G.width);var E=parseInt(G.height);D=isNaN(D)?0:D;C=isNaN(C)?0:C;v=isNaN(v)?0:v;E=isNaN(E)?0:E;var B=parseInt(Math.floor(C/F.tile_h));var A=parseInt(Math.floor(D/F.tile_w));var z=parseInt(Math.floor((C+E)/F.tile_h));var w=parseInt(Math.floor((D+v)/F.tile_w));return{si:B,sj:A,ei:z,ej:w}};g.prototype.setTile=function(x,w,y){var v=this;if(v.tiles[x]===undefined){v.tiles[x]=[]}if(v.tiles[x][w]===undefined){v.tiles[x][w]=[]}v.tiles[x][w][y.layer]=y;return v};g.prototype.getTile=function(y,w,x){var v=this;if(v.tiles[y]!==undefined&&v.tiles[y][w]!==undefined&&v.tiles[y][w][x]!==undefined){return v.tiles[y][w][x]}return null};g.prototype.removeTile=function(y,w,x){var v=this;if(v.tiles[y]!==undefined&&v.tiles[y][w]!==undefined&&v.tiles[y][w][x]!==undefined){delete v.tiles[y][w][x]}};g.prototype.getFullWidth=function(){var v=this;return v.width*v.tile_w};g.prototype.getFullHeight=function(){var v=this;return v.height*v.tile_h};g.prototype.addEvent=function(w){var v=this;v.events.push(w);v._colideTree.insert(w.bounds)};g.prototype.eachTile=function(y){var v=this;for(var x=0;x<v.height;x++){for(var w=0;w<v.width;w++){if(v.tiles[x]!==undefined&&v.tiles[x][w]!==undefined){v.tiles[x][w].forEach(function(A,z){y(A,x,w,z)})}}}};var i=function(w,x){var v=this;v.width=10;v.height=10;v.x=0;v.y=0;v.parent=x};i.TOP_LEFT=0;i.TOP_CENTER=1;i.TOP_RIGHT=2;i.CENTER_LEFT=3;i.CENTER_CENTER=4;i.CENTER_RIGHT=5;i.BOTTOM_LEFT=6;i.BOTTOM_CENTER=7;i.BOTTOM_RIGHT=8;var l={loadedImages:[],loadAll:function(v,w){h(v,[],w)},load:function(y,z){var x=this;var v=document.createElement("a");v.href=y;y=$(v).prop("href");if(x.loadedImages[y]===undefined){var w=new Image();w.crossOrigin="Anonymous";w.src=y;w.onload=function(){x.loadedImages[y]=w;z(w)}}else{z(x.loadedImages[y])}},toDataURL:function(v,z){var w=document.createElement("canvas");var x=w.getContext("2d");w.width=v.width;w.height=v.height;x.drawImage(v,0,0);var y=w.toDataURL();z(y);w=null}};var h=function(v,x,y){x=x===undefined?[]:x;if(v.length>0){var w=v.shift();l.load(w,function(z){x.push(z);h(v,x,y)})}else{if(typeof y==="function"){y(x)}}};var n={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(A,B,C){var y=this;B=B===undefined||!(B instanceof g)?new g():B;var w=parseInt(A.tile_w);var z=parseInt(A.tile_h);w=isNaN(w)?32:w;z=isNaN(z)?32:z;B.tile_w=w;B.tile_h=z;var v=A.tilesets!==undefined?A.tilesets:[];var x=A.tiles!==undefined?A.tiles:[];B.colision=A.colision!==undefined?A.colision:[];l.loadAll(v,function(D){x.forEach(function(F,E){if(F!==null){F.forEach(function(G,H){if(G!==null){G.forEach(function(J,I){if(J!==null){var K={};y.fields.forEach(function(N,M){if(J[M]!==undefined){K[N]=J[M]}});if(K.image!==undefined){var L=K.image;if(D[L]!==undefined){K.image=D[L]}}B.setTile(E,H,K)}else{B.removeTile(E,H)}})}})}});C(B)})}};c.Direction=a;c.Graphic=p;c.Character=e;c.CanvasEngine=r;c.Event=u;c.Page=m;c.Map=g;c.MapLoader=n;c.ImageLoader=l;c.Player=q;c.Trigger=d;k.RPG=c})(window);