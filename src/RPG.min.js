(function(l){var k=l.CE,b=k.CE;var c={};var e={calculate_final_position:function(w,v,u,x,t){}};var q=function(t,v,x){x=x===undefined?true:x;if(x){v.clear()}v.rect(t.bounds);if(x){var w=t.objects;w.forEach(function(y){v.rect(y)})}if(!t.isLeaf()){for(var u=0;u<t.nodes.length;u++){q(t.nodes[u],v,false)}}};var p=function(u){var t=this;b.call(t,u)};p.prototype=Object.create(b.prototype);p.constructor=p;p.prototype.drawMap=function(x){var u=this;var t=x.getAreaInterval({x:0,y:0,width:x.getFullWidth(),height:x.getFullHeight()});for(var w=t.si;w<=t.ei;w++){for(var v=t.sj;v<=t.ej;v++){if(x.tiles[w]!==undefined&&x.tiles[w][v]!==undefined){x.tiles[w][v].forEach(function(z,y){if(u.layers[y]!==undefined){if(z!==null){u.layers[y].clearRect({x:z.dx,y:z.dy,width:z.dWidth,height:z.dHeight});u.layers[y].image(z)}}})}}}};p.prototype.drawQuadTree=function(t,v){var u=this;v=u.getLayer(v);q(t,v)};p.prototype.drawCharacter=function(x){if(!x.refreshed&&x.graphic!==null){var t=x.layer;var u=this;if(u.layers[t]!==undefined){var v=u.layers[t];var w=x.bounds;var A=x.graphic;v.clearRect({x:w.lx,y:w.ly,width:w.width,height:w.height});var z=x.getCurrentFrame();if(z!==undefined){var y={image:z.image,sx:z.sx,sy:z.sy,dx:w.x,dy:w.y,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight};v.image(y);w.lx=w.x;w.ly=w.y;x.refreshed=true}}}};var n=function(u){var t=this;t.conditions=[];t.graphic=null;t.script=null;t.event=u};n.Conditions={LOCAL_SWITCH:1,GLOBAL_SWITH:2,VARIABLE:3};n.prototype.addCondition=function(v,u,w){var t=this;var y={type:v,name:u,value:w};t.conditions.push(y);var x=function(){t.event.activePage=t};switch(v){case n.Conditions.LOCAL_SWITCH:t.event.switchCallback(u,w,x);break;case n.Conditions.GLOBAL_SWITH:t.event.game.switchCallback(u,w,x);break;case n.Conditions.VARIABLE:break}};var s=function(F){var D=this;var u=F.pages;var w=F.position;var B=F.direction;var C=F.parent;var t=F.activePage;if(u instanceof Array){var E=u.length;for(var v=0;v<E;v++){if((u[v] instanceof n)){u.splice(v,1);v--}}}else{u=[]}if(w.constructor==={}.constructor){var A=parseFloat(w.x);var z=parseFloat(w.y);A=isNaN(A)?0:A;z=isNaN(z)?0:z;w.x=A;w.y=z}else{w={x:0,y:0}}C=C===undefined?null:C;t=t===undefined?0:t;D.pages=u;D.position=w;D.direction=s.DOWN;D.moving=false;D.switches=[];D.switches_callbacks=[];D.game=null;D.activePage=null};s.prototype.enableSwitch=function(u){var t=this;t.switches[u]=true};s.prototype.disableSwitch=function(u){var t=this;t.switches[u]=false};s.prototype.switchCallback=function(v,t,x){var u=this;if(u.switches_callbacks[v]===undefined){u.switches_callbacks[v]=[]}var w=t?1:0;if(u.switches_callbacks[v][w]===undefined){u.switches_callbacks[v][w]=[]}u.switches_callbacks[v][w].push(x)};s.prototype.addPage=function(u){var t=this;t.pages.push(u)};s.prototype.destroy=function(){};s.prototype.setGame=function(u){var t=this;t.game=u};var r=function(u){var t=this;var w=u.frames===undefined?[]:u.frames;var v=parseFloat(u.fps);v=isNaN(v)||v<=0?3:v;t.fps=v;t.frames=w;t.start_time=null;t.end_time=null;t.running=false};r.prototype.getIndexFrame=function(){var t=this;var v=t.frames.length;var w=null;if(t.running){w=(new Date()).getTime()-t.start_time}else{w=t.end_time-t.start_time}var u=((w/1000)*t.fps)%v;u=u===0?v-1:u-1;return Math.abs(Math.ceil(u))};r.prototype.stop=function(){var t=this;t.pause()};r.prototype.execute=function(){var t=this;if(!t.running){t.start_time=(new Date()).getTime();t.running=true}};r.prototype.pause=function(){var t=this;if(t.running){t.end_time=(new Date()).getTime();t.running=false}};r.prototype.pauseToFrame=function(u){var t=this;if(t.frames[u]!==undefined){var v=(u/t.fps)*1000;t.end_time=t.start_time+v;t.running=false}};var a={DOWN:0,LEFT:1,RIGHT:2,UP:3};var f=function(B){var z=this;var u=B.image;var A=parseInt(B.rows);var w=parseInt(B.cols);A=isNaN(A)?1:A;w=isNaN(w)?1:w;var v=parseInt(B.up);var t=parseInt(B.left);var y=parseInt(B.right);var x=parseInt(B.down);x=isNaN(x)?a.DOWN:x;t=isNaN(t)?a.LEFT:t;y=isNaN(y)?a.RIGHT:y;v=isNaN(v)?a.UP:v;z.up=v;z.down=x;z.right=y;z.left=t;z.image=u;z.rows=A;z.cols=w;z.width=u.width/z.cols;z.height=u.height/z.rows;z.animations=[];z.initialize()};f.prototype.initialize=function(){var t=this;for(var v=0;v<t.rows;v++){var x=[];for(var u=0;u<t.cols;u++){var w={image:t.image,sWidth:t.width,sHeight:t.height,dWidth:t.width,dHeight:t.height,sx:u*t.width,sy:v*t.height};x.push(w)}t.animations[v]=new r({frames:x,fps:t.cols*2})}};var d=function(u){var t=this;u=u==undefined?{}:u;t.initialize(u)};d.prototype.initialize=function(v){var u=this;var w=parseInt(v.speed);var t=parseInt(v.x);var z=parseInt(v.y);t=isNaN(t)?0:t;z=isNaN(z)?0:z;w=isNaN(w)?5:Math.abs(w);u.speed=w;u.graphic=null;u.bounds={x:t,y:z,width:0,height:0,lx:t,ly:z};u.layer=2;u.moving=false;u.direction=a.DOWN;u.refreshed=false;u.h_speed=32;u.v_speed=32;u.start_moving_time=(new Date()).getTime();u.moving_time=0;u.moving_callback=null;u.start_position={x:t,y:t};u.end_position={x:t,y:z};u.current_map=null};d.prototype.setCurrentMap=function(u){var t=this;t.current_map=u};d.prototype.moveTo=function(t,z,v,w){var u=this;u.start_moving_time=(new Date()).getTime();u.moving_time=v;u.start_position={x:u.bounds.x,y:u.bounds.y};u.end_position={x:t,y:z};u.moving_callback=w};d.prototype.timeStepMove=function(){var D=this;var u=(new Date()).getTime();var z=u-D.start_moving_time;if(z>=D.moving_time){D.bounds.x=D.end_position.x;D.bounds.y=D.end_position.y;var A=D.moving_callback;D.moving_callback=null;if(typeof A==="function"){A()}}else{var C=(D.end_position.x-D.start_position.x);var B=(D.end_position.y-D.start_position.y);var w=D.start_position.x+((C*z)/D.moving_time);var v=D.start_position.y+((B*z)/D.moving_time);D.bounds.x=w;D.bounds.y=v;QuadTree.reInsert(D.bounds);var t=QuadTree.getCollisions(D.bounds);t.forEach(function(x){x.backgroundColor="rgba(0,0,255,0.5)"})}};d.prototype.setGraphic=function(u){var t=this;t.graphic=u;t.bounds.width=u.width;t.bounds.height=u.height};d.prototype.getCurrentFrame=function(){var t=this;var u=t.graphic.animations[t.direction];return u.frames[u.getIndexFrame()]};d.prototype.step=function(A,B,u,w){var v=this;w=w==undefined?false:w;if(!v.moving||w){v.moving=true;var t=v.bounds.x;var C=v.bounds.y;var z=1000/v.speed;B=B===undefined?1:B;switch(A){case a.UP:C-=v.h_speed;break;case a.RIGHT:t+=v.h_speed;break;case a.LEFT:t-=v.h_speed;break;case a.DOWN:C+=v.h_speed;break}if(B<1){v.moving=false;if(typeof u==="function"){u()}}else{v.graphic.animations[A].execute();v.direction=A;v.moveTo(t,C,z,function(){B--;v.step(A,B,u,true)})}}};d.prototype.stepForward=function(){var t=this;t.step(t.direction)};var h=function(w){var v=this;var z=parseInt(w.width);var t=parseInt(w.height);var u=parseInt(w.tile_w);var y=parseInt(w.tile_h);var x=w.events;z=isNaN(z)?10:z;t=isNaN(t)?10:t;u=isNaN(u)?32:u;y=isNaN(y)?32:y;v.width=z;v.height=t;v.tile_w=u;v.tile_h=y;v.tiles=[];v.events=[];v.parent=null;v._colideTree=null;v.colision=[]};h.prototype.initializeColision=function(){var t=this;t._colideTree=new QuadTree({x:0,y:0,width:t.getFullWidth(),height:t.getFullHeight()});var y=t.colision.length;for(var w=0;w<y;w++){var x=t.colision[w].length;for(var v=0;v<x;v++){var u=t.colision[w][v];if(u===true){t._colideTree.insert({x:v*t.tile_w,y:w*t.tile_h,width:t.tile_w,height:t.tile_h})}}}};h.prototype.getAreaInterval=function(E){var D=this;var B=parseInt(E.x);var A=parseInt(E.y);var t=parseInt(E.width);var C=parseInt(E.height);B=isNaN(B)?0:B;A=isNaN(A)?0:A;t=isNaN(t)?0:t;C=isNaN(C)?0:C;var z=parseInt(Math.floor(A/D.tile_h));var w=parseInt(Math.floor(B/D.tile_w));var v=parseInt(Math.floor((A+C)/D.tile_h));var u=parseInt(Math.floor((B+t)/D.tile_w));return{si:z,sj:w,ei:v,ej:u}};h.prototype.setTile=function(v,u,w){var t=this;if(t.tiles[v]===undefined){t.tiles[v]=[]}if(t.tiles[v][u]===undefined){t.tiles[v][u]=[]}t.tiles[v][u][w.layer]=w;return t};h.prototype.getTile=function(w,u,v){var t=this;if(t.tiles[w]!==undefined&&t.tiles[w][u]!==undefined&&t.tiles[w][u][v]!==undefined){return t.tiles[w][u][v]}return null};h.prototype.removeTile=function(w,u,v){var t=this;if(t.tiles[w]!==undefined&&t.tiles[w][u]!==undefined&&t.tiles[w][u][v]!==undefined){delete t.tiles[w][u][v]}};h.prototype.getFullWidth=function(){var t=this;return t.width*t.tile_w};h.prototype.getFullHeight=function(){var t=this;return t.height*t.tile_h};h.prototype.addEvent=function(u){var t=this;t.events.push(u)};h.prototype.eachTile=function(w){var t=this;for(var v=0;v<t.height;v++){for(var u=0;u<t.width;u++){if(t.tiles[v]!==undefined&&t.tiles[v][u]!==undefined){t.tiles[v][u].forEach(function(y,x){w(y,v,u,x)})}}}};var g=function(v){var u=this;v=v===undefined?{}:v;var w=v.fps===undefined?30:v.fps;var t=v.debug==undefined?false:v.debug;u.switches=[];u.switches_callbacks=[];u.variables=[];u.current_map=null;u.canvas_engine=null;u.key_reader=null;u.start_time=null;u.fps=w;u.interval=null;u.paused=true;u.running=false;u.character=null;u.command=null;u.events=[];u.debug=t};g.prototype.setCharacter=function(u){var t=this;t.character=u;if(u.currentMap!==t.current_map){u.setCurrentMap(t.current_map)}};g.prototype.setCurrentMap=function(u){var t=this;t.current_map=u};g.prototype.initialize=function(){var t=this;if(t.canvas_engine!==null){t.canvas_engine.removeLayers(t.canvas_engine.layers);for(var u=0;u<10;u++){t.canvas_engine.createLayer()}t.key_reader=t.canvas_engine.getKeyReader();t.canvas_engine.createLayer();t.key_reader.on([KeyReader.Keys.KEY_ENTER],function(){if(t.paused){t.start()}else{t.pause()}})}};g.prototype.initializeMap=function(u){var t=this;t.current_map=u;t.character.setCurrentMap(u);t.canvas_engine.drawMap(u);u._colideTree.insert(t.character.bounds)};g.prototype.setCanvasEngine=function(u){var t=this;t.canvas_engine=u};g.prototype.enableSwitch=function(u){var t=this;t.switches[u]=true;if(t.switches_callbacks[u]!==undefined&&t.switches_callbacks[u][1]!==undefined){t.switches_callbacks[u][1].forEach(function(v){v()})}};g.prototype.disableSwitch=function(u){var t=this;t.switches[u]=false;if(t.switches_callbacks[u]!==undefined&&t.switches_callbacks[u][0]!==undefined){t.switches_callbacks[u][0].forEach(function(v){v()})}};g.prototype.switchCallback=function(v,t,w,y){var u=this;if(u.switches_callbacks[v]===undefined){u.switches_callbacks[v]=[]}var x=t?1:0;if(u.switches_callbacks[v][x]===undefined){u.switches_callbacks[v][x]=[]}u.switches_callbacks[v][x].push(y)};g.prototype.start=function(){var t=this;t.start_time=(new Date()).getTime();if(!t.running){t.running=true;t.step();console.log("game started")}};g.prototype.pause=function(){var t=this;t.running=false;l.cancelAnimationFrame(t.interval);console.log("game paused")};g.prototype.stepEvents=function(){var t=this;if(!t.character.moving){if(t.key_reader.isActive(KeyReader.Keys.KEY_LEFT)){t.character.step(a.LEFT)}else{if(t.key_reader.isActive(KeyReader.Keys.KEY_RIGHT)){t.character.step(a.RIGHT)}else{if(t.key_reader.isActive(KeyReader.Keys.KEY_DOWN)){t.character.step(a.DOWN)}else{if(t.key_reader.isActive(KeyReader.Keys.KEY_UP)){t.character.step(a.UP)}else{t.character.graphic.animations[t.character.direction].pauseToFrame(3);t.character.refreshed=false}}}}}else{t.character.timeStepMove();t.character.refreshed=false}t.events.forEach(function(u){if(u.moving){u.timeStepMove();u.refreshed=false}})};g.prototype.drawEvents=function(){var t=this;if(!t.character.refreshed){t.canvas_engine.drawCharacter(t.character)}};g.prototype.step=function(){var t=this;if(t.running){t.interval=l.requestAnimationFrame(function(){t.step()});t.stepEvents();t.drawEvents();if(t.debug){t.canvas_engine.drawQuadTree(t.current_map._colideTree,10)}}};g.prototype.getSeconds=function(){var t=this;return parseInt(((new Date()).getTime()-t.start_time)/1000)};var j=function(u,v){var t=this;t.width=10;t.height=10;t.x=0;t.y=0;t.parent=v};j.TOP_LEFT=0;j.TOP_CENTER=1;j.TOP_RIGHT=2;j.CENTER_LEFT=3;j.CENTER_CENTER=4;j.CENTER_RIGHT=5;j.BOTTOM_LEFT=6;j.BOTTOM_CENTER=7;j.BOTTOM_RIGHT=8;var m={loadedImages:[],loadAll:function(t,u){i(t,[],u)},load:function(w,x){var v=this;var t=document.createElement("a");t.href=w;w=$(t).prop("href");if(v.loadedImages[w]===undefined){var u=new Image();u.crossOrigin="Anonymous";u.src=w;u.onload=function(){v.loadedImages[w]=u;x(u)}}else{x(v.loadedImages[w])}},toDataURL:function(t,x){var u=document.createElement("canvas");var v=u.getContext("2d");u.width=t.width;u.height=t.height;v.drawImage(t,0,0);var w=u.toDataURL();x(w);u=null}};var i=function(t,v,w){v=v===undefined?[]:v;if(t.length>0){var u=t.shift();m.load(u,function(x){v.push(x);i(t,v,w)})}else{if(typeof w==="function"){w(v)}}};var o={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(v,t,z){var A=this;t=t===undefined||!(t instanceof h)?new h():t;var B=parseInt(v.tile_w);var w=parseInt(v.tile_h);B=isNaN(B)?32:B;w=isNaN(w)?32:w;t.tile_w=B;t.tile_h=w;var u=v.tilesets!==undefined?v.tilesets:[];var y=v.tiles!==undefined?v.tiles:[];var x=v.colision!==undefined?v.colision:[];t.colision=x;m.loadAll(u,function(C){y.forEach(function(E,D){if(E!==null){E.forEach(function(F,G){if(F!==null){F.forEach(function(I,H){if(I!==null){var J={};A.fields.forEach(function(M,L){if(I[L]!==undefined){J[M]=I[L]}});if(J.image!==undefined){var K=J.image;if(C[K]!==undefined){J.image=C[K]}}t.setTile(D,G,J)}else{t.removeTile(D,G)}})}})}});z(t)})}};c.Direction=a;c.CharacterGraphic=f;c.Character=d;c.CanvasEngine=p;c.Event=s;c.Page=n;c.Map=h;c.Game=g;c.MapLoader=o;l.RPG=c})(window);