(function(g){var i=g.CE,p=i.CE;var n={};var d=function(s){var r=this;p.call(r,s)};d.prototype=Object.create(p.prototype);d.constructor=d;d.prototype.drawMap=function(v){var s=this;var r=v.getAreaInterval({x:0,y:0,width:v.getFullWidth(),height:v.getFullHeight()});for(var u=r.si;u<=r.ei;u++){for(var t=r.sj;t<=r.ej;t++){if(v.tiles[u]!==undefined&&v.tiles[u][t]!==undefined){v.tiles[u][t].forEach(function(x,w){if(s.layers[w]!==undefined){if(x!==null){s.layers[w].clearRect({x:x.dx,y:x.dy,width:x.dWidth,height:x.dHeight});s.layers[w].image(x)}}})}}}};d.prototype.drawCharacter=function(u){if(!u.refreshed&&u.graphic!==null){var r=u.layer;var s=this;if(s.layers[r]!==undefined){var t=s.layers[r];var x=u.graphic;t.clearRect({x:u.position.lx,y:u.position.ly,width:x.width,height:x.height});var w=u.getCurrentFrame();if(w!==undefined){var v={image:w.image,sx:w.sx,sy:w.sy,dx:u.position.x,dy:u.position.y,dWidth:w.dWidth,dHeight:w.dHeight,sWidth:w.sWidth,sHeight:w.sHeight};t.image(v);u.position.lx=u.position.x;u.position.ly=u.position.y;u.refreshed=true}}}};var q=function(s){var r=this;r.conditions=[];r.graphic=null;r.script=null;r.event=s};q.Conditions={LOCAL_SWITCH:1,GLOBAL_SWITH:2,VARIABLE:3};q.prototype.addCondition=function(t,s,u){var r=this;var w={type:t,name:s,value:u};r.conditions.push(w);var v=function(){r.event.activePage=r};switch(t){case q.Conditions.LOCAL_SWITCH:r.event.switchCallback(s,u,v);break;case q.Conditions.GLOBAL_SWITH:r.event.game.switchCallback(s,u,v);break;case q.Conditions.VARIABLE:break}};var m=function(D){var B=this;var s=D.pages;var u=D.position;var z=D.direction;var A=D.parent;var r=D.activePage;if(s instanceof Array){var C=s.length;for(var t=0;t<C;t++){if((s[t] instanceof q)){s.splice(t,1);t--}}}else{s=[]}if(u.constructor==={}.constructor){var w=parseFloat(u.x);var v=parseFloat(u.y);w=isNaN(w)?0:w;v=isNaN(v)?0:v;u.x=w;u.y=v}else{u={x:0,y:0}}A=A===undefined?null:A;r=r===undefined?0:r;B.pages=s;B.position=u;B.direction=m.DOWN;B.moving=false;B.switches=[];B.switchesCallbacks=[];B.game=null;B.activePage=null};m.prototype.enableSwitch=function(s){var r=this;r.switches[s]=true};m.prototype.disableSwitch=function(s){var r=this;r.switches[s]=false};m.prototype.switchCallback=function(t,r,v){var s=this;if(s.switchesCallbacks[t]===undefined){s.switchesCallbacks[t]=[]}var u=r?1:0;if(s.switchesCallbacks[t][u]===undefined){s.switchesCallbacks[t][u]=[]}s.switchesCallbacks[t][u].push(v)};m.prototype.addPage=function(s){var r=this;r.pages.push(s)};m.prototype.destroy=function(){};m.prototype.setGame=function(s){var r=this;r.game=s};var e=function(s){var r=this;var u=s.frames===undefined?[]:s.frames;var t=parseFloat(s.fps);t=isNaN(t)||t<=0?3:t;r.fps=t;r.frames=u;r.start_time=null;r.end_time=null;r.running=false};e.prototype.getIndexFrame=function(){var r=this;var t=r.frames.length;var u=null;if(r.running){u=(new Date()).getTime()-r.start_time}else{u=r.end_time-r.start_time}var s=((u/1000)*r.fps)%t;s=s===0?t-1:s-1;return Math.abs(Math.ceil(s))};e.prototype.stop=function(){var r=this;r.pause()};e.prototype.execute=function(){var r=this;if(!r.running){r.start_time=(new Date()).getTime();r.running=true}};e.prototype.pause=function(){var r=this;if(r.running){r.end_time=(new Date()).getTime();r.running=false}};e.prototype.pauseToFrame=function(s){var r=this;if(r.frames[s]!==undefined){var t=(s/r.fps)*1000;r.end_time=r.start_time+t;r.running=false}};var o={DOWN:0,LEFT:1,RIGHT:2,UP:3};var f=function(z){var x=this;var s=z.image;var y=parseInt(z.rows);var u=parseInt(z.cols);y=isNaN(y)?1:y;u=isNaN(u)?1:u;var t=parseInt(z.up);var r=parseInt(z.left);var w=parseInt(z.right);var v=parseInt(z.down);v=isNaN(v)?o.DOWN:v;r=isNaN(r)?o.LEFT:r;w=isNaN(w)?o.RIGHT:w;t=isNaN(t)?o.UP:t;x.up=t;x.down=v;x.right=w;x.left=r;x.image=s;x.rows=y;x.cols=u;x.width=s.width/x.cols;x.height=s.height/x.rows;x.animations=[];x.initialize()};f.prototype.initialize=function(){var r=this;for(var t=0;t<r.rows;t++){var v=[];for(var s=0;s<r.cols;s++){var u={image:r.image,sWidth:r.width,sHeight:r.height,dWidth:r.width,dHeight:r.height,sx:s*r.width,sy:t*r.height};v.push(u)}r.animations[t]=new e({frames:v,fps:r.cols*2})}};var j=function(s){var r=this;r.graphic=null;r.speed=5;r.position={x:0,y:0,lx:0,ly:0};r.layer=3;r.animate_step=null;r.animate_sync=null;r.moving=false;r.direction=o.DOWN;r.refreshed=false};j.prototype.moveTo=function(H,A){var E=this;var z=H.x===undefined?E.position.x:H.x;var v=H.y===undefined?E.position.y:H.y;var D=H.frameRate===undefined?30:H.frameRate;var s=H.time===undefined?1000:H.time;var F=(D*s)/1000;var r=1000/D;var C=(new Date()).getTime();var t=(new Date()).getTime();var G=(z-E.position.x)/F;var B=(v-E.position.y)/F;var w=E.position.x;var u=E.position.y;E.stepMove(w,u,G,B,F,r,C,s,D,A)};j.prototype.stepMove=function(w,v,E,D,C,r,B,u,A,y){var z=this;var s=(new Date()).getTime();var x=s-B;if(x<u){var t=(x*A)/1000;z.position.x=Math.round(w+(E*t));z.position.y=Math.round(v+(D*t));z.refreshed=false;g.requestAnimationFrame(function(){z.stepMove(w,v,E,D,C,r,B,u,A,y)})}else{z.position.x=w+(E*C);z.position.y=v+(D*C);z.refreshed=false;clearInterval(z.animate_step);g.cancelAnimationFrame(z.animate_sync);if(y){y()}}};j.prototype.setGraphic=function(s){var r=this;r.graphic=s};j.prototype.getCurrentFrame=function(){var r=this;var s=r.graphic.animations[r.direction];return s.frames[s.getIndexFrame()]};j.prototype.step=function(v,w,r,t){var s=this;t=t==undefined?false:t;if(!s.moving||t){s.moving=true;var u={x:s.position.x,y:s.position.y,time:1000/s.speed};w=w===undefined?1:w;switch(v){case o.UP:u.y-=32;break;case o.RIGHT:u.x+=32;break;case o.LEFT:u.x-=32;break;case o.DOWN:u.y+=32;break}s.graphic.animations[v].execute();s.direction=v;s.moveTo(u,function(){if(w>1){w--;s.step(v,w,r,true)}else{s.moving=false;if(typeof r==="function"){r()}}})}};j.prototype.stepForward=function(){var r=this;r.step(r.direction)};var b=function(u){var t=this;var x=parseInt(u.width);var r=parseInt(u.height);var s=parseInt(u.tile_w);var w=parseInt(u.tile_h);var v=u.events;x=isNaN(x)?10:x;r=isNaN(r)?10:r;s=isNaN(s)?32:s;w=isNaN(w)?32:w;t.width=x;t.height=r;t.tile_w=s;t.tile_h=w;t.tiles=[];t.events=[];t.parent=null};b.prototype.getAreaInterval=function(C){var B=this;var z=parseInt(C.x);var w=parseInt(C.y);var r=parseInt(C.width);var A=parseInt(C.height);z=isNaN(z)?0:z;w=isNaN(w)?0:w;r=isNaN(r)?0:r;A=isNaN(A)?0:A;var v=parseInt(Math.floor(w/B.tile_h));var u=parseInt(Math.floor(z/B.tile_w));var t=parseInt(Math.floor((w+A)/B.tile_h));var s=parseInt(Math.floor((z+r)/B.tile_w));return{si:v,sj:u,ei:t,ej:s}};b.prototype.setTile=function(t,s,u){var r=this;if(r.tiles[t]===undefined){r.tiles[t]=[]}if(r.tiles[t][s]===undefined){r.tiles[t][s]=[]}r.tiles[t][s][u.layer]=u;return r};b.prototype.getTile=function(u,s,t){var r=this;if(r.tiles[u]!==undefined&&r.tiles[u][s]!==undefined&&r.tiles[u][s][t]!==undefined){return r.tiles[u][s][t]}return null};b.prototype.removeTile=function(u,s,t){var r=this;if(r.tiles[u]!==undefined&&r.tiles[u][s]!==undefined&&r.tiles[u][s][t]!==undefined){delete r.tiles[u][s][t]}};b.prototype.getFullWidth=function(){var r=this;return r.width*r.tile_w};b.prototype.getFullHeight=function(){var r=this;return r.height*r.tile_h};b.prototype.addEvent=function(s){var r=this;r.events.push(s)};b.prototype.eachTile=function(u){var r=this;for(var t=0;t<r.height;t++){for(var s=0;s<r.width;s++){if(r.tiles[t]!==undefined&&r.tiles[t][s]!==undefined){r.tiles[t][s].forEach(function(w,v){u(w,t,s,v)})}}}};var c=function(s){var r=this;s=s===undefined?{}:s;var t=s.fps===undefined?30:s.fps;r.switches=[];r.switchesCallbacks=[];r.variables=[];r.currentMap=null;r.canvasEngine=null;r.key_reader=null;r.start_time=null;r.fps=t;r.interval1=null;r.interval2=null;r.paused=true;r.running=false;r.character=null;r.command=null};c.prototype.setCharacter=function(s){var r=this;r.character=s};c.prototype.initialize=function(){var r=this;if(r.canvasEngine!==null){r.canvasEngine.removeLayers(r.canvasEngine.layers);for(var s=0;s<10;s++){r.canvasEngine.createLayer()}r.key_reader=r.canvasEngine.getKeyReader()}};c.prototype.initializeMap=function(s){var r=this;r.canvasEngine.drawMap(s)};c.prototype.setCanvasEngine=function(s){var r=this;r.canvasEngine=s};c.prototype.enableSwitch=function(s){var r=this;r.switches[s]=true;if(r.switchesCallbacks[s]!==undefined&&r.switchesCallbacks[s][1]!==undefined){r.switchesCallbacks[s][1].forEach(function(t){t()})}};c.prototype.disableSwitch=function(s){var r=this;r.switches[s]=false;if(r.switchesCallbacks[s]!==undefined&&r.switchesCallbacks[s][0]!==undefined){r.switchesCallbacks[s][0].forEach(function(t){t()})}};c.prototype.switchCallback=function(t,r,u,w){var s=this;if(s.switchesCallbacks[t]===undefined){s.switchesCallbacks[t]=[]}var v=r?1:0;if(s.switchesCallbacks[t][v]===undefined){s.switchesCallbacks[t][v]=[]}s.switchesCallbacks[t][v].push(w)};c.prototype.start=function(){var r=this;r.start_time=(new Date()).getTime();if(!r.running){r.running=true;r.step()}};c.prototype.pause=function(){var r=this;r.running=false;clearInterval(r.frameInterval);g.cancelAnimationFrame(r.frameSync)};c.prototype.stepEvents=function(){var r=this;if(!r.character.moving){if(r.key_reader.isActive(KeyReader.Keys.KEY_LEFT)){r.character.step(o.LEFT)}else{if(r.key_reader.isActive(KeyReader.Keys.KEY_RIGHT)){r.character.step(o.RIGHT)}else{if(r.key_reader.isActive(KeyReader.Keys.KEY_DOWN)){r.character.step(o.DOWN)}else{if(r.key_reader.isActive(KeyReader.Keys.KEY_UP)){r.character.step(o.UP)}else{r.character.graphic.animations[r.character.direction].pauseToFrame(3)}}}}}};c.prototype.drawEvents=function(){var r=this;if(!r.character.refreshed){r.canvasEngine.drawCharacter(r.character)}};c.prototype.step=function(){var r=this;if(r.running){r.interval2=g.requestAnimationFrame(function(){r.step()});r.stepEvents();r.drawEvents()}};c.prototype.getSeconds=function(){var r=this;return parseInt(((new Date()).getTime()-r.start_time)/1000)};var l=function(s,t){var r=this;r.width=10;r.height=10;r.x=0;r.y=0;r.parent=t};l.TOP_LEFT=0;l.TOP_CENTER=1;l.TOP_RIGHT=2;l.CENTER_LEFT=3;l.CENTER_CENTER=4;l.CENTER_RIGHT=5;l.BOTTOM_LEFT=6;l.BOTTOM_CENTER=7;l.BOTTOM_RIGHT=8;var k={loadedImages:[],loadAll:function(r,s){a(r,[],s)},load:function(u,v){var t=this;var r=document.createElement("a");r.href=u;u=$(r).prop("href");if(t.loadedImages[u]===undefined){var s=new Image();s.crossOrigin="Anonymous";s.src=u;s.onload=function(){t.loadedImages[u]=s;v(s)}}else{v(t.loadedImages[u])}},toDataURL:function(r,v){var s=document.createElement("canvas");var t=s.getContext("2d");s.width=r.width;s.height=r.height;t.drawImage(r,0,0);var u=s.toDataURL();v(u);s=null}};var a=function(r,t,u){t=t===undefined?[]:t;if(r.length>0){var s=r.shift();k.load(s,function(v){t.push(v);a(r,t,u)})}else{if(typeof u==="function"){u(t)}}};var h={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(w,x,y){var u=this;x=x===undefined||!(x instanceof b)?new b():x;var s=parseInt(w.tile_w);var v=parseInt(w.tile_h);s=isNaN(s)?32:s;v=isNaN(v)?32:v;x.tile_w=s;x.tile_h=v;var r=w.tilesets!==undefined?w.tilesets:[];var t=w.tiles!==undefined?w.tiles:[];k.loadAll(r,function(z){t.forEach(function(B,A){if(B!==null){B.forEach(function(C,D){if(C!==null){C.forEach(function(F,E){if(F!==null){var G={};u.fields.forEach(function(J,I){if(F[I]!==undefined){G[J]=F[I]}});if(G.image!==undefined){var H=G.image;if(z[H]!==undefined){G.image=z[H]}}x.setTile(A,D,G)}else{x.removeTile(A,D)}})}})}});y(x)})}};n.Direction=o;n.CharacterGraphic=f;n.Character=j;n.CanvasEngine=d;n.Event=m;n.Page=q;n.Map=b;n.Game=c;n.MapLoader=h;g.RPG=n})(window);