(function(k){var j=k.CE,b=j.CE;var c={};var p=function(t){var s=this;b.call(s,t)};p.prototype=Object.create(b.prototype);p.constructor=p;p.prototype.drawMap=function(w){var t=this;var s=w.getAreaInterval({x:0,y:0,width:w.getFullWidth(),height:w.getFullHeight()});for(var v=s.si;v<=s.ei;v++){for(var u=s.sj;u<=s.ej;u++){if(w.tiles[v]!==undefined&&w.tiles[v][u]!==undefined){w.tiles[v][u].forEach(function(y,x){if(t.layers[x]!==undefined){if(y!==null){t.layers[x].clearRect({x:y.dx,y:y.dy,width:y.dWidth,height:y.dHeight});t.layers[x].image(y)}}})}}}};p.prototype.drawCharacter=function(v){if(!v.refreshed&&v.graphic!==null){var s=v.layer;var t=this;if(t.layers[s]!==undefined){var u=t.layers[s];var y=v.graphic;u.clearRect({x:v.position.lx,y:v.position.ly,width:y.width,height:y.height});var x=v.getCurrentFrame();if(x!==undefined){var w={image:x.image,sx:x.sx,sy:x.sy,dx:v.position.x,dy:v.position.y,dWidth:x.dWidth,dHeight:x.dHeight,sWidth:x.sWidth,sHeight:x.sHeight};u.image(w);v.position.lx=v.position.x;v.position.ly=v.position.y;v.refreshed=true}}}};var m=function(t){var s=this;s.conditions=[];s.graphic=null;s.script=null;s.event=t};m.Conditions={LOCAL_SWITCH:1,GLOBAL_SWITH:2,VARIABLE:3};m.prototype.addCondition=function(u,t,v){var s=this;var x={type:u,name:t,value:v};s.conditions.push(x);var w=function(){s.event.activePage=s};switch(u){case m.Conditions.LOCAL_SWITCH:s.event.switchCallback(t,v,w);break;case m.Conditions.GLOBAL_SWITH:s.event.game.switchCallback(t,v,w);break;case m.Conditions.VARIABLE:break}};var r=function(E){var C=this;var t=E.pages;var v=E.position;var A=E.direction;var B=E.parent;var s=E.activePage;if(t instanceof Array){var D=t.length;for(var u=0;u<D;u++){if((t[u] instanceof m)){t.splice(u,1);u--}}}else{t=[]}if(v.constructor==={}.constructor){var z=parseFloat(v.x);var w=parseFloat(v.y);z=isNaN(z)?0:z;w=isNaN(w)?0:w;v.x=z;v.y=w}else{v={x:0,y:0}}B=B===undefined?null:B;s=s===undefined?0:s;C.pages=t;C.position=v;C.direction=r.DOWN;C.moving=false;C.switches=[];C.switchesCallbacks=[];C.game=null;C.activePage=null};r.prototype.enableSwitch=function(t){var s=this;s.switches[t]=true};r.prototype.disableSwitch=function(t){var s=this;s.switches[t]=false};r.prototype.switchCallback=function(u,s,w){var t=this;if(t.switchesCallbacks[u]===undefined){t.switchesCallbacks[u]=[]}var v=s?1:0;if(t.switchesCallbacks[u][v]===undefined){t.switchesCallbacks[u][v]=[]}t.switchesCallbacks[u][v].push(w)};r.prototype.addPage=function(t){var s=this;s.pages.push(t)};r.prototype.destroy=function(){};r.prototype.setGame=function(t){var s=this;s.game=t};var q=function(t){var s=this;var v=t.frames===undefined?[]:t.frames;var u=parseFloat(t.fps);u=isNaN(u)||u<=0?3:u;s.fps=u;s.frames=v;s.start_time=null;s.end_time=null;s.running=false};q.prototype.getIndexFrame=function(){var s=this;var u=s.frames.length;var v=null;if(s.running){v=(new Date()).getTime()-s.start_time}else{v=s.end_time-s.start_time}var t=((v/1000)*s.fps)%u;t=t===0?u-1:t-1;return Math.abs(Math.ceil(t))};q.prototype.stop=function(){var s=this;s.pause()};q.prototype.execute=function(){var s=this;if(!s.running){s.start_time=(new Date()).getTime();s.running=true}};q.prototype.pause=function(){var s=this;if(s.running){s.end_time=(new Date()).getTime();s.running=false}};q.prototype.pauseToFrame=function(t){var s=this;if(s.frames[t]!==undefined){var u=(t/s.fps)*1000;s.end_time=s.start_time+u;s.running=false}};var a={DOWN:0,LEFT:1,RIGHT:2,UP:3};var e=function(A){var y=this;var t=A.image;var z=parseInt(A.rows);var v=parseInt(A.cols);z=isNaN(z)?1:z;v=isNaN(v)?1:v;var u=parseInt(A.up);var s=parseInt(A.left);var x=parseInt(A.right);var w=parseInt(A.down);w=isNaN(w)?a.DOWN:w;s=isNaN(s)?a.LEFT:s;x=isNaN(x)?a.RIGHT:x;u=isNaN(u)?a.UP:u;y.up=u;y.down=w;y.right=x;y.left=s;y.image=t;y.rows=z;y.cols=v;y.width=t.width/y.cols;y.height=t.height/y.rows;y.animations=[];y.initialize()};e.prototype.initialize=function(){var s=this;for(var u=0;u<s.rows;u++){var w=[];for(var t=0;t<s.cols;t++){var v={image:s.image,sWidth:s.width,sHeight:s.height,dWidth:s.width,dHeight:s.height,sx:t*s.width,sy:u*s.height};w.push(v)}s.animations[u]=new q({frames:w,fps:s.cols*2})}};var n={colideRect:function(t,s){return !((t.x>(s.x+s.width)||s.x>(t.x+t.width)||t.y>(t.y+t.height)||s.y>(s.y+s.height)))}};var d=function(t){var s=this;s.initialize()};d.prototype.initialize=function(){var s=this;s.graphic=null;s.speed=5;s.position={x:0,y:0,lx:0,ly:0};s.layer=3;s.moving=false;s.direction=a.DOWN;s.refreshed=false;s.currentMap=null;s.stepDistance=32;s.start_moving_time=(new Date()).getTime();s.moving_time=0;s.moving_callback=null;s.start_position={x:0,y:0};s.end_position={x:0,y:0}};d.prototype.getArea=function(){var s=this;return{x:s.position.x,y:s.position.y,width:s.graphic.width,height:s.graphic.height}};d.prototype.setMap=function(t){var s=this;s.map=t;if(s.map.character!==s){s.map.setCharacter(s)}};d.prototype.moveTo=function(s,w,u,v){console.log("move to");var t=this;t.start_moving_time=(new Date()).getTime();t.moving_time=u;t.start_position={x:t.position.x,y:t.position.y};t.end_position={x:s,y:w};t.moving_callback=v};d.prototype.timeStepMove=function(){var t=this;var u=(new Date()).getTime();var z=u-t.start_moving_time;if(z>=t.moving_time){t.position.x=t.end_position.x;t.position.y=t.end_position.y;var B=t.moving_callback;t.moving_callback=null;if(typeof B==="function"){B()}}else{var w=(t.end_position.x-t.start_position.x);var v=(t.end_position.y-t.start_position.y);var s=t.start_position.x+((w*z)/t.moving_time);var A=t.start_position.y+((v*z)/t.moving_time);t.position.x=s;t.position.y=A}};d.prototype.setGraphic=function(t){var s=this;s.graphic=t};d.prototype.getCurrentFrame=function(){var s=this;var t=s.graphic.animations[s.direction];return t.frames[t.getIndexFrame()]};d.prototype.step=function(z,A,t,v){var u=this;v=v==undefined?false:v;if(!u.moving||v){u.moving=true;var s=u.position.x;var B=u.position.y;var w=1000/u.speed;A=A===undefined?1:A;switch(z){case a.UP:B-=u.stepDistance;break;case a.RIGHT:s+=u.stepDistance;break;case a.LEFT:s-=u.stepDistance;break;case a.DOWN:B+=u.stepDistance;break}u.graphic.animations[z].execute();u.direction=z;u.moveTo(s,B,w,function(){if(A>1){A--;u.step(z,A,t,true)}else{u.moving=false;if(typeof t==="function"){t()}}})}};d.prototype.stepForward=function(){var s=this;s.step(s.direction)};var g=function(v){var u=this;var y=parseInt(v.width);var s=parseInt(v.height);var t=parseInt(v.tile_w);var x=parseInt(v.tile_h);var w=v.events;y=isNaN(y)?10:y;s=isNaN(s)?10:s;t=isNaN(t)?32:t;x=isNaN(x)?32:x;u.width=y;u.height=s;u.tile_w=t;u.tile_h=x;u.tiles=[];u.events=[];u.parent=null};g.prototype.getAreaInterval=function(D){var C=this;var A=parseInt(D.x);var z=parseInt(D.y);var s=parseInt(D.width);var B=parseInt(D.height);A=isNaN(A)?0:A;z=isNaN(z)?0:z;s=isNaN(s)?0:s;B=isNaN(B)?0:B;var w=parseInt(Math.floor(z/C.tile_h));var v=parseInt(Math.floor(A/C.tile_w));var u=parseInt(Math.floor((z+B)/C.tile_h));var t=parseInt(Math.floor((A+s)/C.tile_w));return{si:w,sj:v,ei:u,ej:t}};g.prototype.setTile=function(u,t,v){var s=this;if(s.tiles[u]===undefined){s.tiles[u]=[]}if(s.tiles[u][t]===undefined){s.tiles[u][t]=[]}s.tiles[u][t][v.layer]=v;return s};g.prototype.getTile=function(v,t,u){var s=this;if(s.tiles[v]!==undefined&&s.tiles[v][t]!==undefined&&s.tiles[v][t][u]!==undefined){return s.tiles[v][t][u]}return null};g.prototype.removeTile=function(v,t,u){var s=this;if(s.tiles[v]!==undefined&&s.tiles[v][t]!==undefined&&s.tiles[v][t][u]!==undefined){delete s.tiles[v][t][u]}};g.prototype.getFullWidth=function(){var s=this;return s.width*s.tile_w};g.prototype.getFullHeight=function(){var s=this;return s.height*s.tile_h};g.prototype.addEvent=function(t){var s=this;s.events.push(t)};g.prototype.eachTile=function(v){var s=this;for(var u=0;u<s.height;u++){for(var t=0;t<s.width;t++){if(s.tiles[u]!==undefined&&s.tiles[u][t]!==undefined){s.tiles[u][t].forEach(function(x,w){v(x,u,t,w)})}}}};var f=function(t){var s=this;t=t===undefined?{}:t;var u=t.fps===undefined?30:t.fps;s.switches=[];s.switchesCallbacks=[];s.variables=[];s.currentMap=null;s.canvasEngine=null;s.key_reader=null;s.start_time=null;s.fps=u;s.interval1=null;s.interval2=null;s.paused=true;s.running=false;s.character=null;s.command=null};f.prototype.setCharacter=function(t){var s=this;s.character=t;if(t.map!==s){t.setMap(s)}};f.prototype.initialize=function(){var s=this;if(s.canvasEngine!==null){s.canvasEngine.removeLayers(s.canvasEngine.layers);for(var t=0;t<10;t++){s.canvasEngine.createLayer()}s.key_reader=s.canvasEngine.getKeyReader()}};f.prototype.initializeMap=function(t){var s=this;s.canvasEngine.drawMap(t)};f.prototype.setCanvasEngine=function(t){var s=this;s.canvasEngine=t};f.prototype.enableSwitch=function(t){var s=this;s.switches[t]=true;if(s.switchesCallbacks[t]!==undefined&&s.switchesCallbacks[t][1]!==undefined){s.switchesCallbacks[t][1].forEach(function(u){u()})}};f.prototype.disableSwitch=function(t){var s=this;s.switches[t]=false;if(s.switchesCallbacks[t]!==undefined&&s.switchesCallbacks[t][0]!==undefined){s.switchesCallbacks[t][0].forEach(function(u){u()})}};f.prototype.switchCallback=function(u,s,v,x){var t=this;if(t.switchesCallbacks[u]===undefined){t.switchesCallbacks[u]=[]}var w=s?1:0;if(t.switchesCallbacks[u][w]===undefined){t.switchesCallbacks[u][w]=[]}t.switchesCallbacks[u][w].push(x)};f.prototype.start=function(){var s=this;s.start_time=(new Date()).getTime();if(!s.running){s.running=true;s.step()}};f.prototype.pause=function(){var s=this;s.running=false;clearInterval(s.frameInterval);k.cancelAnimationFrame(s.frameSync)};f.prototype.stepEvents=function(){var s=this;if(!s.character.moving){if(s.key_reader.isActive(KeyReader.Keys.KEY_LEFT)){s.character.step(a.LEFT)}else{if(s.key_reader.isActive(KeyReader.Keys.KEY_RIGHT)){s.character.step(a.RIGHT)}else{if(s.key_reader.isActive(KeyReader.Keys.KEY_DOWN)){s.character.step(a.DOWN)}else{if(s.key_reader.isActive(KeyReader.Keys.KEY_UP)){s.character.step(a.UP)}else{s.character.graphic.animations[s.character.direction].pauseToFrame(3);s.character.refreshed=false}}}}}else{s.character.timeStepMove();s.character.refreshed=false}};f.prototype.drawEvents=function(){var s=this;if(!s.character.refreshed){s.canvasEngine.drawCharacter(s.character)}};f.prototype.step=function(){var s=this;if(s.running){s.interval2=k.requestAnimationFrame(function(){s.step()});s.stepEvents();s.drawEvents()}};f.prototype.getSeconds=function(){var s=this;return parseInt(((new Date()).getTime()-s.start_time)/1000)};var h=function(t,u){var s=this;s.width=10;s.height=10;s.x=0;s.y=0;s.parent=u};h.TOP_LEFT=0;h.TOP_CENTER=1;h.TOP_RIGHT=2;h.CENTER_LEFT=3;h.CENTER_CENTER=4;h.CENTER_RIGHT=5;h.BOTTOM_LEFT=6;h.BOTTOM_CENTER=7;h.BOTTOM_RIGHT=8;var l={loadedImages:[],loadAll:function(s,t){i(s,[],t)},load:function(v,w){var u=this;var s=document.createElement("a");s.href=v;v=$(s).prop("href");if(u.loadedImages[v]===undefined){var t=new Image();t.crossOrigin="Anonymous";t.src=v;t.onload=function(){u.loadedImages[v]=t;w(t)}}else{w(u.loadedImages[v])}},toDataURL:function(s,w){var t=document.createElement("canvas");var u=t.getContext("2d");t.width=s.width;t.height=s.height;u.drawImage(s,0,0);var v=t.toDataURL();w(v);t=null}};var i=function(s,u,v){u=u===undefined?[]:u;if(s.length>0){var t=s.shift();l.load(t,function(w){u.push(w);i(s,u,v)})}else{if(typeof v==="function"){v(u)}}};var o={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(x,y,z){var v=this;y=y===undefined||!(y instanceof g)?new g():y;var t=parseInt(x.tile_w);var w=parseInt(x.tile_h);t=isNaN(t)?32:t;w=isNaN(w)?32:w;y.tile_w=t;y.tile_h=w;var s=x.tilesets!==undefined?x.tilesets:[];var u=x.tiles!==undefined?x.tiles:[];l.loadAll(s,function(A){u.forEach(function(C,B){if(C!==null){C.forEach(function(D,E){if(D!==null){D.forEach(function(G,F){if(G!==null){var H={};v.fields.forEach(function(K,J){if(G[J]!==undefined){H[K]=G[J]}});if(H.image!==undefined){var I=H.image;if(A[I]!==undefined){H.image=A[I]}}y.setTile(B,E,H)}else{y.removeTile(B,E)}})}})}});z(y)})}};c.Direction=a;c.CharacterGraphic=e;c.Character=d;c.CanvasEngine=p;c.Event=r;c.Page=m;c.Map=g;c.Game=f;c.MapLoader=o;k.RPG=c})(window);