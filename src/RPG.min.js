(function(j){var i=j.CE,b=i.CE;var e={calculate_final_position:function(t,A,z,x){var u={x:A,y:z,width:t.width,height:t.height};var w={x:A-t.x,y:z-t.y};var y=c.Globals.current_map._colideTree;QuadTree.remove(t);y.insert(u);var v=QuadTree.getCollisions(u);QuadTree.remove(u);y.insert(t);v.forEach(function(E){if(w.x>0&&E.x<(u.x+t.width)){u.x=E.x-t.width}else{if(w.x<0&&((E.x+E.width)>u.x)){u.x=E.x+E.width}}if(w.y>0&&E.y<(u.y+t.height)){u.y=E.y-t.height}else{if(w.y<0&&((E.y+E.height)>u.y)){u.y=E.y+E.height}}});if(u.x<0){u.x=0}else{if(u.x>c.Globals.current_map.getFullWidth()-32){u.x=c.Globals.current_map.getFullWidth()-32}else{if(w.x>0){u.x=Math.max(u.x,t.x)}else{if(w.x<0){u.x=Math.min(u.x,t.x)}else{u.x=t.x}}}}if(u.y<0){u.y=0}else{if(u.y>c.Globals.current_map.getFullHeight()-32){u.y=c.Globals.current_map.getFullHeight()-32}else{if(w.y>0){u.y=Math.max(u.y,t.y)}else{if(w.y<0){u.y=Math.min(u.y,t.y)}else{u.y=t.y}}}}var D=this;var C=D.distance({x:t.x,y:t.y},{x:A,y:z});var B=D.distance({x:t.x,y:t.y},{x:u.x,y:u.y});x=(x*B)/C;return{x:u.x,y:u.y,time:x}},distance:function(u,t){return Math.sqrt(Object.keys(u).reduce(function(v,w){return v+Math.pow(u[w]-t[w],2)},0))}};var c={Globals:{current_map:null,current_player:null,switches:[],variables:[],paused:true,start_time:null},_screen_width:600,_screen_height:600,_switches_callbacks:[],_canvas_engine:null,_key_reader:null,_interval:null,_running:false,_debug:false,_focused_event:null,_layers:{BG1:null,BG2:null,BG3:null,EV1:null,EV2:null,BG4:null,BG5:null,BG6:null,BG7:null,BG8:null,QUAD:null,menu1:null,menu2:null,menu3:null},_switchCallback:function(v,t,w,y){var u=this;if(c._switches_callbacks[v]===undefined){c._switches_callbacks[v]=[]}var x=t?1:0;if(c._switches_callbacks[v][x]===undefined){c._switches_callbacks[v][x]=[]}c._switches_callbacks[v][x].push(y)},initialize:function(u){var v=i.createEngine({width:c._screen_width,height:c._screen_height,container:u},p);var t=v.getKeyReader();c._layers.BG1=v.createLayer();c._layers.BG2=v.createLayer();c._layers.BG3=v.createLayer();c._layers.EV1=v.createLayer();c._layers.EV2=v.createLayer();c._layers.BG4=v.createLayer();c._layers.BG5=v.createLayer();c._layers.BG6=v.createLayer();c._layers.BG7=v.createLayer();c._layers.BG8=v.createLayer();c._layers.QUAD=v.createLayer();c._layers.menu1=v.createLayer();c._layers.menu2=v.createLayer();c._layers.menu3=v.createLayer();t.on(["KEY_ENTER"],function(){if(c.Globals.paused){c.start()}else{c.pause()}});c._key_reader=t;c._canvas_engine=v},loadMap:function(v){c.Globals.current_map=v;var u=v.getFullWidth();var t=v.getFullHeight();c._layers.BG1.set({width:u,height:t});c._layers.BG2.set({width:u,height:t});c._layers.BG3.set({width:u,height:t});c._layers.EV1.set({width:u,height:t});c._layers.EV2.set({width:u,height:t});c._layers.BG4.set({width:u,height:t});c._layers.BG5.set({width:u,height:t});c._layers.BG6.set({width:u,height:t});c._layers.BG7.set({width:u,height:t});c._layers.BG8.set({width:u,height:t});c._layers.QUAD.set({width:u,height:t});c._canvas_engine.drawMap(v);v._colideTree.insert(c.Globals.current_player.bounds)},enableSwitch:function(u){var t=this;c.Globals.switches[u]=true;if(c._switches_callbacks[u]!==undefined&&c._switches_callbacks[u][1]!==undefined){c._switches_callbacks[u][1].forEach(function(v){v()})}},disableSwitch:function(u){var t=this;c.Globals.switches[u]=false;if(c._switches_callbacks[u]!==undefined&&c._switches_callbacks[u][0]!==undefined){c._switches_callbacks[u][0].forEach(function(v){v()})}},run:function(){c.Globals.start_time=(new Date()).getTime();console.log("game started");if(!c._running){c._running=true;c.step()}},end:function(){var t=this;c._running=false;j.cancelAnimationFrame(c._interval)},stepEvents:function(){var v=this;var u=c.Globals.current_player;var t=c._key_reader;if(!u._moving){if(t.isActive("KEY_LEFT")){u.step(a.LEFT)}else{if(t.isActive("KEY_RIGHT")){u.step(a.RIGHT)}else{if(t.isActive("KEY_DOWN")){u.step(a.DOWN)}else{if(t.isActive("KEY_UP")){u.step(a.UP)}else{var w="step_"+u.direction;u.graphic.animations[w].pauseToFrame(1);u._refreshed=false}}}}}else{u._timeStepMove();u._refreshed=false}},drawEvents:function(){var t=c.Globals.current_player;if(!t._refreshed){c._canvas_engine.drawCharacter(t)}},step:function(){if(c._running){c._interval=j.requestAnimationFrame(function(){c.step()});c.stepEvents();c.drawEvents();if(c._debug){c._canvas_engine.drawQuadTree(c.Globals.current_map._colideTree,10)}}},getSeconds:function(){return parseInt(((new Date()).getTime()-c.Globals.start_time)/1000)},_focusOnEvent:function(u){var t=this;if(t._focused_event!==null){t._focused_event._camera_focus=false}u._camera_focus=true;t._focused_event=u}};var q=function(t,v,x){x=x===undefined?true:x;if(x){v.clear()}v.rect(t.bounds);if(x){var w=t.objects;w.forEach(function(y){v.rect(y)})}if(!t.isLeaf()){for(var u=0;u<t.nodes.length;u++){q(t.nodes[u],v,false)}}};var p=function(u){var t=this;b.call(t,u)};p.prototype=Object.create(b.prototype);p.constructor=p;p.prototype.drawMap=function(x){var u=this;var t=x.getAreaInterval({x:0,y:0,width:x.getFullWidth(),height:x.getFullHeight()});for(var w=t.si;w<=t.ei;w++){for(var v=t.sj;v<=t.ej;v++){if(x.tiles[w]!==undefined&&x.tiles[w][v]!==undefined){x.tiles[w][v].forEach(function(z,y){if(u.layers[y]!==undefined){if(z!==null){u.layers[y].clearRect({x:z.dx,y:z.dy,width:z.dWidth,height:z.dHeight});u.layers[y].image(z)}}})}}}};p.prototype.drawQuadTree=function(t,v){var u=this;v=u.getLayer(v);q(t,v)};p.prototype.drawCharacter=function(B){if(!B._refreshed&&B.graphic!==null){var z=B.layer;var E=this;if(E.layers[z]!==undefined){var A=E.layers[z];var t=B.bounds;var u=B.graphic;A.clearRect({x:u.lx,y:u.ly,width:u.width,height:u.height});var v=B.getCurrentFrame();var D=t.x-(Math.max(u.width-32,0));var C=t.y-(Math.max(u.height-32,0));if(v!==undefined){var w={image:v.image,sx:v.sx,sy:v.sy,dx:D,dy:C,dWidth:v.dWidth,dHeight:v.dHeight,sWidth:v.sWidth,sHeight:v.sHeight};A.image(w);u.lx=D;u.ly=C;B._refreshed=true}}}};var l=function(u){var t=this;t.conditions=[];t.graphic=null;t.script=null;t.event=u};l.Conditions={LOCAL_SWITCH:1,GLOBAL_SWITH:2,VARIABLE:3};l.prototype.addCondition=function(v,u,w){var t=this;var y={type:v,name:u,value:w};t.conditions.push(y);var x=function(){t.event.activePage=t};switch(v){case l.Conditions.LOCAL_SWITCH:t.event._switchCallback(u,w,x);break;case l.Conditions.GLOBAL_SWITH:t.event._game.switchCallback(u,w,x);break;case l.Conditions.VARIABLE:break}};var r=function(u){var t=this;var w=u.frames===undefined?[]:u.frames;var v=parseFloat(u.fps);v=isNaN(v)||v<=0?3:v;t.name=u.name===undefined?"":u.name;t.fps=v;t.frames=w;t.start_time=null;t.end_time=null;t.running=false};r.prototype.getIndexFrame=function(){var t=this;var v=t.frames.length;var w=null;if(t.running){w=(new Date()).getTime()-t.start_time}else{w=t.end_time-t.start_time}var u=((w/1000)*t.fps)%v;u=u===0?v-1:u-1;return Math.abs(Math.ceil(u))};r.prototype.stop=function(){var t=this;t.pause()};r.prototype.execute=function(){var t=this;if(!t.running){t.start_time=(new Date()).getTime();t.running=true}};r.prototype.pause=function(){var t=this;if(t.running){t.end_time=(new Date()).getTime();t.running=false}};r.prototype.pauseToFrame=function(u){var t=this;if(t.frames[u]!==undefined){var v=(u/t.fps)*1000;t.end_time=t.start_time+v;t.running=false}};r.create=function(I){var w=parseFloat(I.fps);var H=parseInt(I.rows);var F=parseInt(I.cols);var D=parseInt(I.si);var z=parseInt(I.ei);var B=parseInt(I.sj);var x=parseInt(I.ej);H=isNaN(H)?1:H;F=isNaN(F)?1:F;w=isNaN(w)?F*2:w;D=isNaN(D)?0:D;z=isNaN(z)?H-1:z;B=isNaN(B)?0:B;x=isNaN(x)?F-1:x;var y=I.image;var u=y.width/F;var G=y.height/H;var t=I.name;var E=[];for(var C=D;C<=z&&C<H;C++){for(var A=B;A<=x&&A<F;A++){var v={image:y,sWidth:u,sHeight:G,dWidth:u,dHeight:G,sx:A*u,sy:C*G};E.push(v)}}return new r({name:"name",frames:E,fps:w})};var a={DOWN:"down",LEFT:"left",RIGHT:"right",UP:"up"};var n=function(u){var t=this;var x=u.image;var v=parseInt(u.rows);var w=parseInt(u.cols);v=isNaN(v)?1:v;w=isNaN(w)?1:w;t.image=x;t.rows=v;t.cols=w;t.width=x.width/t.cols;t.height=x.height/t.rows;t.animations={};t.lx=0;t.ly=0;t._initialize()};n.prototype._initialize=function(){var t=this;var u=t.image;t.animations.step_down=r.create({rows:4,cols:4,si:0,ei:0,image:u});t.animations.step_left=r.create({rows:4,cols:4,si:1,ei:1,image:u});t.animations.step_right=r.create({rows:4,cols:4,si:2,ei:2,image:u});t.animations.step_up=r.create({rows:4,cols:4,si:3,ei:3,image:u})};var d=function(u){var t=this;u=u===undefined?{}:u;t.initialize(u)};d.prototype.initialize=function(v){var u=this;var w=parseInt(v.speed);var t=parseInt(v.x);var z=parseInt(v.y);t=isNaN(t)?0:t;z=isNaN(z)?0:z;w=isNaN(w)?5:Math.abs(w);u.speed=w;u.graphic=null;u.bounds={x:t,y:z,width:32,height:32};u.layer=2;u.direction=a.DOWN;u.h_speed=32;u.v_speed=32;u._moving=false;u._refreshed=false;u._start_moving_time=(new Date()).getTime();u._moving_time=0;u._moving_callback=null;u._start_position={x:t,y:z};u._end_position={x:t,y:z};u._camera_focus=false};d.prototype.setPosition=function(t,v){var u=this;u.bounds.x=t;u.bounds.y=v;u.updateFocus()};d.prototype.moveTo=function(t,A,w,z){var u=this;var v=e.calculate_final_position(u.bounds,t,A,w);u._start_moving_time=(new Date()).getTime();u._moving_time=v.time;u._start_position={x:u.bounds.x,y:u.bounds.y};u._end_position={x:v.x,y:v.y};u._moving_callback=z};d.prototype._timeStepMove=function(){var u=this;var v=(new Date()).getTime();var A=v-u._start_moving_time;if(A>=u._moving_time){u.bounds.x=u._end_position.x;u.bounds.y=u._end_position.y;var C=u._moving_callback;u._moving_callback=null;if(typeof C==="function"){C()}}else{var z=(u._end_position.x-u._start_position.x);var w=(u._end_position.y-u._start_position.y);var t=u._start_position.x+((z*A)/u._moving_time);var B=u._start_position.y+((w*A)/u._moving_time);u.bounds.x=t;u.bounds.y=B;u.updateFocus();QuadTree.reInsert(u.bounds)}};d.prototype.updateFocus=function(){var D=this;if(D._camera_focus){var v=c._screen_width;var z=c._screen_height;var B=v/2;var w=z/2;var C=D.bounds.x;var A=D.bounds.y;var u=-C+B-(D.graphic.width/2);var t=-A+w-(D.graphic.height/2);c._canvas_engine.set({viewX:u,viewY:t})}};d.prototype.setGraphic=function(u){var t=this;t.graphic=u;u.lx=t.bounds.x;u.ly=t.bounds.y};d.prototype.getCurrentFrame=function(){var t=this;var v="step_"+t.direction;var u=t.graphic.animations[v];return u.frames[u.getIndexFrame()]};d.prototype.step=function(B,u,z,v){var D=this;v=v===undefined?false:v;if(!D._moving||v){D._moving=true;var C=D.bounds.x;var A=D.bounds.y;var w=1000/D.speed;u=u===undefined?1:u;switch(B){case a.UP:A-=D.h_speed;break;case a.RIGHT:C+=D.h_speed;break;case a.LEFT:C-=D.h_speed;break;case a.DOWN:A+=D.h_speed;break}if(u<1){D._moving=false;if(typeof z==="function"){z()}}else{var t="step_"+B;D.graphic.animations[t].execute();D.direction=B;D.moveTo(C,A,w,function(){u--;D.step(B,u,z,true)})}}};d.prototype.stepForward=function(){var t=this;t.step(t.direction)};var s=function(u){var t=this;d.call(t,u);t.switches=[];t._switches_callbacks=[];t.activePage=-1};s.prototype=Object.create(d.prototype);s.constructor=s;s.prototype.enableSwitch=function(u){var t=this;t.switches[u]=true};s.prototype.disableSwitch=function(u){var t=this;t.switches[u]=false};s.prototype._switchCallback=function(v,t,x){var u=this;if(u._switches_callbacks[v]===undefined){u._switches_callbacks[v]=[]}var w=t?1:0;if(u._switches_callbacks[v][w]===undefined){u._switches_callbacks[v][w]=[]}u._switches_callbacks[v][w].push(x)};s.prototype.addPage=function(u){var t=this;t.pages.push(u)};s.prototype.destroy=function(){};var o=function(u){var t=this;t.level=1;t.hp=100;t.mp=100;t.items=[];t.equiped_items=[];d.call(t,u)};o.prototype=Object.create(d.prototype);o.constructor=o;var f=function(w){var v=this;var z=parseInt(w.width);var t=parseInt(w.height);var u=parseInt(w.tile_w);var y=parseInt(w.tile_h);var x=w.events;z=isNaN(z)?10:z;t=isNaN(t)?10:t;u=isNaN(u)?32:u;y=isNaN(y)?32:y;v.width=z;v.height=t;v.tile_w=u;v.tile_h=y;v.tiles=[];v.events=[];v.parent=null;v._colideTree=null;v.colision=[]};f.prototype.initializeColision=function(){var t=this;t._colideTree=new QuadTree({x:0,y:0,width:t.getFullWidth(),height:t.getFullHeight()});var y=t.colision.length;for(var w=0;w<y;w++){var x=t.colision[w].length;for(var v=0;v<x;v++){var u=t.colision[w][v];if(u===true){t._colideTree.insert({x:v*t.tile_w,y:w*t.tile_h,width:t.tile_w,height:t.tile_h})}}}};f.prototype.getAreaInterval=function(E){var D=this;var B=parseInt(E.x);var A=parseInt(E.y);var t=parseInt(E.width);var C=parseInt(E.height);B=isNaN(B)?0:B;A=isNaN(A)?0:A;t=isNaN(t)?0:t;C=isNaN(C)?0:C;var z=parseInt(Math.floor(A/D.tile_h));var w=parseInt(Math.floor(B/D.tile_w));var v=parseInt(Math.floor((A+C)/D.tile_h));var u=parseInt(Math.floor((B+t)/D.tile_w));return{si:z,sj:w,ei:v,ej:u}};f.prototype.setTile=function(v,u,w){var t=this;if(t.tiles[v]===undefined){t.tiles[v]=[]}if(t.tiles[v][u]===undefined){t.tiles[v][u]=[]}t.tiles[v][u][w.layer]=w;return t};f.prototype.getTile=function(w,u,v){var t=this;if(t.tiles[w]!==undefined&&t.tiles[w][u]!==undefined&&t.tiles[w][u][v]!==undefined){return t.tiles[w][u][v]}return null};f.prototype.removeTile=function(w,u,v){var t=this;if(t.tiles[w]!==undefined&&t.tiles[w][u]!==undefined&&t.tiles[w][u][v]!==undefined){delete t.tiles[w][u][v]}};f.prototype.getFullWidth=function(){var t=this;return t.width*t.tile_w};f.prototype.getFullHeight=function(){var t=this;return t.height*t.tile_h};f.prototype.addEvent=function(u){var t=this;t.events.push(u)};f.prototype.eachTile=function(w){var t=this;for(var v=0;v<t.height;v++){for(var u=0;u<t.width;u++){if(t.tiles[v]!==undefined&&t.tiles[v][u]!==undefined){t.tiles[v][u].forEach(function(y,x){w(y,v,u,x)})}}}};var h=function(u,v){var t=this;t.width=10;t.height=10;t.x=0;t.y=0;t.parent=v};h.TOP_LEFT=0;h.TOP_CENTER=1;h.TOP_RIGHT=2;h.CENTER_LEFT=3;h.CENTER_CENTER=4;h.CENTER_RIGHT=5;h.BOTTOM_LEFT=6;h.BOTTOM_CENTER=7;h.BOTTOM_RIGHT=8;var k={loadedImages:[],loadAll:function(t,u){g(t,[],u)},load:function(w,x){var v=this;var t=document.createElement("a");t.href=w;w=$(t).prop("href");if(v.loadedImages[w]===undefined){var u=new Image();u.crossOrigin="Anonymous";u.src=w;u.onload=function(){v.loadedImages[w]=u;x(u)}}else{x(v.loadedImages[w])}},toDataURL:function(t,x){var u=document.createElement("canvas");var v=u.getContext("2d");u.width=t.width;u.height=t.height;v.drawImage(t,0,0);var w=u.toDataURL();x(w);u=null}};var g=function(t,v,w){v=v===undefined?[]:v;if(t.length>0){var u=t.shift();k.load(u,function(x){v.push(x);g(t,v,w)})}else{if(typeof w==="function"){w(v)}}};var m={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(y,z,A){var w=this;z=z===undefined||!(z instanceof f)?new f():z;var u=parseInt(y.tile_w);var x=parseInt(y.tile_h);u=isNaN(u)?32:u;x=isNaN(x)?32:x;z.tile_w=u;z.tile_h=x;var t=y.tilesets!==undefined?y.tilesets:[];var v=y.tiles!==undefined?y.tiles:[];z.colision=y.colision!==undefined?y.colision:[];k.loadAll(t,function(B){v.forEach(function(D,C){if(D!==null){D.forEach(function(E,F){if(E!==null){E.forEach(function(H,G){if(H!==null){var I={};w.fields.forEach(function(L,K){if(H[K]!==undefined){I[L]=H[K]}});if(I.image!==undefined){var J=I.image;if(B[J]!==undefined){I.image=B[J]}}z.setTile(C,F,I)}else{z.removeTile(C,F)}})}})}});A(z)})}};c.Direction=a;c.Graphic=n;c.Character=d;c.CanvasEngine=p;c.Event=s;c.Page=l;c.Map=f;c.MapLoader=m;c.Player=o;j.RPG=c})(window);