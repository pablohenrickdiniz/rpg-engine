(function(j){var i=j.CE,b=i.CE;var e={calculate_final_position:function(u,B,A,y){var v={x:B,y:A,width:u.width,height:u.height};var x={x:B-u.x,y:A-u.y};var z=c.Globals.current_map._colideTree;QuadTree.remove(u);z.insert(v);var w=QuadTree.getCollisions(v);QuadTree.remove(v);z.insert(u);w.forEach(function(F){if(x.x>0&&F.x<(v.x+u.width)){v.x=F.x-u.width}else{if(x.x<0&&((F.x+F.width)>v.x)){v.x=F.x+F.width}}if(x.y>0&&F.y<(v.y+u.height)){v.y=F.y-u.height}else{if(x.y<0&&((F.y+F.height)>v.y)){v.y=F.y+F.height}}});if(v.x<0){v.x=0}else{if(v.x>c.Globals.current_map.getFullWidth()-32){v.x=c.Globals.current_map.getFullWidth()-32}else{if(x.x>0){v.x=Math.max(v.x,u.x)}else{if(x.x<0){v.x=Math.min(v.x,u.x)}else{v.x=u.x}}}}if(v.y<0){v.y=0}else{if(v.y>c.Globals.current_map.getFullHeight()-32){v.y=c.Globals.current_map.getFullHeight()-32}else{if(x.y>0){v.y=Math.max(v.y,u.y)}else{if(x.y<0){v.y=Math.min(v.y,u.y)}else{v.y=u.y}}}}var E=this;var D=E.distance({x:u.x,y:u.y},{x:B,y:A});var C=E.distance({x:u.x,y:u.y},{x:v.x,y:v.y});y=(y*C)/D;return{x:v.x,y:v.y,time:y}},distance:function(v,u){return Math.sqrt(Object.keys(v).reduce(function(w,x){return w+Math.pow(v[x]-u[x],2)},0))}};var c={Globals:{current_map:null,current_player:null,switches:[],variables:[],paused:true,start_time:null},_screen_width:600,_screen_height:600,_switches_callbacks:[],_canvas_engine:null,_key_reader:null,_interval:null,_running:false,_debug:false,_focused_event:null,_layers:{BG1:null,BG2:null,BG3:null,EV1:null,EV2:null,BG4:null,BG5:null,BG6:null,BG7:null,BG8:null,QUAD:null,menu1:null,menu2:null,menu3:null},_switchCallback:function(w,u,x,z){var v=this;if(c._switches_callbacks[w]===undefined){c._switches_callbacks[w]=[]}var y=u?1:0;if(c._switches_callbacks[w][y]===undefined){c._switches_callbacks[w][y]=[]}c._switches_callbacks[w][y].push(z)},initialize:function(v){var w=i.createEngine({width:c._screen_width,height:c._screen_height,container:v},q);var u=w.getKeyReader();c._layers.BG1=w.createLayer();c._layers.BG2=w.createLayer();c._layers.BG3=w.createLayer();c._layers.EV1=w.createLayer();c._layers.EV2=w.createLayer();c._layers.BG4=w.createLayer();c._layers.BG5=w.createLayer();c._layers.BG6=w.createLayer();c._layers.BG7=w.createLayer();c._layers.BG8=w.createLayer();c._layers.QUAD=w.createLayer();c._layers.menu1=w.createLayer();c._layers.menu2=w.createLayer();c._layers.menu3=w.createLayer();u.on(["KEY_ENTER"],function(){if(c.Globals.paused){c.start()}else{c.pause()}});c._key_reader=u;c._canvas_engine=w},loadMap:function(w){c.Globals.current_map=w;var v=w.getFullWidth();var u=w.getFullHeight();c._layers.BG1.set({width:v,height:u});c._layers.BG2.set({width:v,height:u});c._layers.BG3.set({width:v,height:u});c._layers.EV1.set({width:v,height:u});c._layers.EV2.set({width:v,height:u});c._layers.BG4.set({width:v,height:u});c._layers.BG5.set({width:v,height:u});c._layers.BG6.set({width:v,height:u});c._layers.BG7.set({width:v,height:u});c._layers.BG8.set({width:v,height:u});c._layers.QUAD.set({width:v,height:u});c._canvas_engine.drawMap(w);w._colideTree.insert(c.Globals.current_player.bounds)},enableSwitch:function(v){var u=this;c.Globals.switches[v]=true;if(c._switches_callbacks[v]!==undefined&&c._switches_callbacks[v][1]!==undefined){c._switches_callbacks[v][1].forEach(function(w){w()})}},disableSwitch:function(v){var u=this;c.Globals.switches[v]=false;if(c._switches_callbacks[v]!==undefined&&c._switches_callbacks[v][0]!==undefined){c._switches_callbacks[v][0].forEach(function(w){w()})}},run:function(){c.Globals.start_time=(new Date()).getTime();console.log("game started");if(!c._running){c._running=true;c.step()}},end:function(){var u=this;c._running=false;j.cancelAnimationFrame(c._interval)},stepEvents:function(){var w=this;var v=c.Globals.current_player;var u=c._key_reader;if(!v._moving){if(u.isActive("KEY_LEFT")){v.step(a.LEFT)}else{if(u.isActive("KEY_RIGHT")){v.step(a.RIGHT)}else{if(u.isActive("KEY_DOWN")){v.step(a.DOWN)}else{if(u.isActive("KEY_UP")){v.step(a.UP)}else{var y="step_"+v.direction;v.graphic.animations[y].pauseToFrame(1);v._refreshed=false}}}}}else{v._timeStepMove();v._refreshed=false}var x=c.Globals.current_map.events;x.forEach(function(z){if(!z._moving){var A="step_"+z.direction;z.graphic.animations[A].pauseToFrame(1);z._refreshed=false}else{z._timeStepMove();z._refreshed=false}})},clearEvents:function(){var u=c.Globals.current_player;var z=c._canvas_engine;var B=c.Globals.current_map;z.clearGraphic(u.layer,u.graphic);var x=B.events;var w=x.length;for(var v=0;v<w;v++){var y=x[v];if(y.current_page!==-1){var A=y.graphic;if(A!==null){z.clearGraphic(y.layer,A)}}}},drawEvents:function(){var u=c.Globals.current_player;var z=c._canvas_engine;var A=c.Globals.current_map;var x=A.events;var w=x.length;for(var v=0;v<w;v++){var y=x[v];if(y.current_page!==-1){z.drawEvent(y)}}z.drawCharacter(u)},step:function(){if(c._running){c._interval=j.requestAnimationFrame(function(){c.step()});c.stepEvents();c.clearEvents();c.drawEvents();if(c._debug){c._canvas_engine.drawQuadTree(c.Globals.current_map._colideTree,10)}}},getSeconds:function(){return parseInt(((new Date()).getTime()-c.Globals.start_time)/1000)},_focusOnEvent:function(v){var u=this;if(u._focused_event!==null){u._focused_event._camera_focus=false}v._camera_focus=true;u._focused_event=v}};var r=function(u,w,y){y=y===undefined?true:y;if(y){w.clear()}w.rect(u.bounds);if(y){var x=u.objects;x.forEach(function(z){w.rect(z)})}if(!u.isLeaf()){for(var v=0;v<u.nodes.length;v++){r(u.nodes[v],w,false)}}};var q=function(v){var u=this;b.call(u,v)};q.prototype=Object.create(b.prototype);q.constructor=q;q.prototype.drawMap=function(y){var v=this;var u=y.getAreaInterval({x:0,y:0,width:y.getFullWidth(),height:y.getFullHeight()});for(var x=u.si;x<=u.ei;x++){for(var w=u.sj;w<=u.ej;w++){if(y.tiles[x]!==undefined&&y.tiles[x][w]!==undefined){y.tiles[x][w].forEach(function(A,z){if(v.layers[z]!==undefined){if(A!==null){v.layers[z].clearRect({x:A.dx,y:A.dy,width:A.dWidth,height:A.dHeight});v.layers[z].image(A)}}})}}}};q.prototype.drawQuadTree=function(u,w){var v=this;w=v.getLayer(w);r(u,w)};q.prototype.drawEvent=function(w){var v=w.pages[w.current_page].graphic;if(v!==null){var B=w.layer;var F=this;if(F.layers[B]!==undefined){var C=F.layers[B];var u=w.bounds;var z=w.getCurrentFrame();var E=u.x-(Math.max(v.width-32,0));var D=u.y-(Math.max(v.height-32,0));if(z!==undefined){var A={image:z.image,sx:z.sx,sy:z.sy,dx:E,dy:D,dWidth:z.dWidth,dHeight:z.dHeight,sWidth:z.sWidth,sHeight:z.sHeight};C.image(A);v.lx=E;v.ly=D;w._refreshed=true}}}};q.prototype.clearGraphic=function(u,x){var v=this;if(v.layers[u]!==undefined){var w=v.layers[u];w.clearRect({x:x.lx,y:x.ly,width:x.width,height:x.height})}};q.prototype.drawCharacter=function(C){if(C.graphic!==null){var A=C.layer;var F=this;if(F.layers[A]!==undefined){var B=F.layers[A];var u=C.bounds;var v=C.graphic;var w=C.getCurrentFrame();var E=u.x-(Math.max(v.width-32,0));var D=u.y-(Math.max(v.height-32,0));if(w!==undefined){var z={image:w.image,sx:w.sx,sy:w.sy,dx:E,dy:D,dWidth:w.dWidth,dHeight:w.dHeight,sWidth:w.sWidth,sHeight:w.sHeight};B.image(z);v.lx=E;v.ly=D;C._refreshed=true}}}};var s=function(v){var u=this;var x=v.frames===undefined?[]:v.frames;var w=parseFloat(v.fps);w=isNaN(w)||w<=0?3:w;u.name=v.name===undefined?"":v.name;u.fps=w;u.frames=x;u.start_time=null;u.end_time=null;u.running=false};s.prototype.getIndexFrame=function(){var u=this;var w=u.frames.length;var x=null;if(u.running){x=(new Date()).getTime()-u.start_time}else{x=u.end_time-u.start_time}var v=((x/1000)*u.fps)%w;v=v===0?w-1:v-1;return Math.abs(Math.ceil(v))};s.prototype.stop=function(){var u=this;u.pause()};s.prototype.execute=function(){var u=this;if(!u.running){u.start_time=(new Date()).getTime();u.running=true}};s.prototype.pause=function(){var u=this;if(u.running){u.end_time=(new Date()).getTime();u.running=false}};s.prototype.pauseToFrame=function(v){var u=this;if(u.frames[v]!==undefined){var w=(v/u.fps)*1000;u.end_time=u.start_time+w;u.running=false}};s.create=function(J){var x=parseFloat(J.fps);var I=parseInt(J.rows);var G=parseInt(J.cols);var E=parseInt(J.si);var A=parseInt(J.ei);var C=parseInt(J.sj);var y=parseInt(J.ej);I=isNaN(I)?1:I;G=isNaN(G)?1:G;x=isNaN(x)?G*2:x;E=isNaN(E)?0:E;A=isNaN(A)?I-1:A;C=isNaN(C)?0:C;y=isNaN(y)?G-1:y;var z=J.image;var v=z.width/G;var H=z.height/I;var u=J.name;var F=[];for(var D=E;D<=A&&D<I;D++){for(var B=C;B<=y&&B<G;B++){var w={image:z,sWidth:v,sHeight:H,dWidth:v,dHeight:H,sx:B*v,sy:D*H};F.push(w)}}return new s({name:"name",frames:F,fps:x})};var a={DOWN:"down",LEFT:"left",RIGHT:"right",UP:"up"};var o=function(v){var u=this;var y=v.image;var w=parseInt(v.rows);var x=parseInt(v.cols);w=isNaN(w)?1:w;x=isNaN(x)?1:x;u.image=y;u.rows=w;u.cols=x;u.width=y.width/u.cols;u.height=y.height/u.rows;u.animations={};u.lx=0;u.ly=0;u._initialize()};o.prototype._initialize=function(){var u=this;var v=u.image;u.animations.step_down=s.create({rows:4,cols:4,si:0,ei:0,image:v});u.animations.step_left=s.create({rows:4,cols:4,si:1,ei:1,image:v});u.animations.step_right=s.create({rows:4,cols:4,si:2,ei:2,image:v});u.animations.step_up=s.create({rows:4,cols:4,si:3,ei:3,image:v})};var d=function(v){var u=this;v=v===undefined?{}:v;u.initialize(v)};d.prototype.initialize=function(w){var v=this;var z=parseInt(w.speed);var u=parseInt(w.x);var A=parseInt(w.y);u=isNaN(u)?0:u;A=isNaN(A)?0:A;z=isNaN(z)?5:Math.abs(z);v.speed=z;v.graphic=null;v.bounds={x:u,y:A,width:32,height:32};v.layer=2;v.direction=a.DOWN;v.h_speed=32;v.v_speed=32;v._moving=false;v._refreshed=false;v._start_moving_time=(new Date()).getTime();v._moving_time=0;v._moving_callback=null;v._start_position={x:u,y:A};v._end_position={x:u,y:A};v._camera_focus=false};d.prototype.setPosition=function(u,w){var v=this;v.bounds.x=u;v.bounds.y=w;v.updateFocus()};d.prototype.moveTo=function(u,B,z,A){var v=this;var w=e.calculate_final_position(v.bounds,u,B,z);v._start_moving_time=(new Date()).getTime();v._moving_time=w.time;v._start_position={x:v.bounds.x,y:v.bounds.y};v._end_position={x:w.x,y:w.y};v._moving_callback=A};d.prototype._timeStepMove=function(){var v=this;var w=(new Date()).getTime();var B=w-v._start_moving_time;if(B>=v._moving_time){v.bounds.x=v._end_position.x;v.bounds.y=v._end_position.y;var D=v._moving_callback;v._moving_callback=null;if(typeof D==="function"){D()}}else{var A=(v._end_position.x-v._start_position.x);var z=(v._end_position.y-v._start_position.y);var u=v._start_position.x+((A*B)/v._moving_time);var C=v._start_position.y+((z*B)/v._moving_time);v.bounds.x=u;v.bounds.y=C;v.updateFocus();QuadTree.reInsert(v.bounds)}};d.prototype.updateFocus=function(){var E=this;if(E._camera_focus){var w=c._screen_width;var A=c._screen_height;var C=w/2;var z=A/2;var D=E.bounds.x;var B=E.bounds.y;var v=-D+C-(E.graphic.width/2);var u=-B+z-(E.graphic.height/2);c._canvas_engine.set({viewX:v,viewY:u})}};d.prototype.setGraphic=function(v){var u=this;u.graphic=v;v.lx=u.bounds.x;v.ly=u.bounds.y};d.prototype.getCurrentFrame=function(){var u=this;var w="step_"+u.direction;var v=u.graphic.animations[w];return v.frames[v.getIndexFrame()]};d.prototype.step=function(C,v,A,w){var E=this;w=w===undefined?false:w;if(!E._moving||w){E._moving=true;var D=E.bounds.x;var B=E.bounds.y;var z=1000/E.speed;v=v===undefined?1:v;switch(C){case a.UP:B-=E.h_speed;break;case a.RIGHT:D+=E.h_speed;break;case a.LEFT:D-=E.h_speed;break;case a.DOWN:B+=E.h_speed;break}if(v<1){E._moving=false;if(typeof A==="function"){A()}}else{var u="step_"+C;E.graphic.animations[u].execute();E.direction=C;E.moveTo(D,B,z,function(){v--;E.step(C,v,A,true)})}}};d.prototype.stepForward=function(){var u=this;u.step(u.direction)};d.prototype.stepRandom=function(){var u=this;var x=Object.keys(a);var w=Math.floor(Math.random()*x.length);var v=x[w];u.step(a[v])};var l=function(v){var u=this;if(v===undefined||!(v.event instanceof t)){throw new Error("Page requires an event")}var w=v.graphic;u.condition=typeof v.conditions==="array"?v.conditions:[];u.graphic=w instanceof o?w:null;u.script=null;u.event=v.event};l.prototype.setGraphic=function(v){var u=this;u.graphic=v};l.Conditions={LOCAL_SWITCH:1,GLOBAL_SWITH:2,VARIABLE:3};var n={ON:"ON",OFF:"OFF"};var t=function(v){var u=this;d.call(u,v);u._switches_callbacks=[];u.switches=[];u.current_page=-1;u.pages=[];Object.defineProperty(u,"graphic",{get:function(){if(u.current_page!==-1&&u.pages[u.current_page].graphic!==null){return u.pages[u.current_page].graphic}return null}})};t.prototype=Object.create(d.prototype);t.constructor=t;t.prototype.getCurrentFrame=function(){var u=this;if(u.current_page!==-1){var w="step_"+u.direction;var v=u.pages[u.current_page].graphic.animations[w];return v.frames[v.getIndexFrame()]}return null};t.prototype.enable_switch=function(v){var u=this;u.switches[v]=true;if(u._switches_callbacks[v]!==undefined&&u._switches_callbacks[v].on!==undefined){u._switches_callbacks[v].on.forEach(function(w){w()})}};t.prototype.disable_switch=function(v){var u=this;u.switches[v]=false;if(u._switches_callbacks[v]!==undefined&&u._switches_callbacks[v].off!==undefined){u._switches_callbacks[v].off.forEach(function(w){w()})}};t.prototype._switchCallback=function(w,u,x){var v=this;if(v._switches_callbacks[w]===undefined){v._switches_callbacks[w]={}}switch(u){case n.ON:if(v._switches_callbacks[w].on===undefined){v._switches_callbacks[w].on=[]}v._switches_callbacks[w].on.push(x);break;case n.OFF:if(v._switches_callbacks[w].off===undefined){v._switches_callbacks[w].off=[]}v._switches_callbacks[w].off.push(x);break;default:throw new Error("Switch status "+u+" is invalid!")}};t.prototype.addPage=function(v){var u=this;u.pages.push(v)};var p=function(v){var u=this;u.level=1;u.hp=100;u.mp=100;u.items=[];u.equiped_items=[];d.call(u,v)};p.prototype=Object.create(d.prototype);p.constructor=p;var f=function(x){var w=this;var A=parseInt(x.width);var u=parseInt(x.height);var v=parseInt(x.tile_w);var z=parseInt(x.tile_h);var y=x.events;A=isNaN(A)?10:A;u=isNaN(u)?10:u;v=isNaN(v)?32:v;z=isNaN(z)?32:z;w.width=A;w.height=u;w.tile_w=v;w.tile_h=z;w.tiles=[];w.events=[];w.parent=null;w._colideTree=null;w.colision=[]};f.prototype.initializeColision=function(){var u=this;u._colideTree=new QuadTree({x:0,y:0,width:u.getFullWidth(),height:u.getFullHeight()});var z=u.colision.length;for(var x=0;x<z;x++){var y=u.colision[x].length;for(var w=0;w<y;w++){var v=u.colision[x][w];if(v===true){u._colideTree.insert({x:w*u.tile_w,y:x*u.tile_h,width:u.tile_w,height:u.tile_h})}}}};f.prototype.getAreaInterval=function(F){var E=this;var C=parseInt(F.x);var B=parseInt(F.y);var u=parseInt(F.width);var D=parseInt(F.height);C=isNaN(C)?0:C;B=isNaN(B)?0:B;u=isNaN(u)?0:u;D=isNaN(D)?0:D;var A=parseInt(Math.floor(B/E.tile_h));var z=parseInt(Math.floor(C/E.tile_w));var w=parseInt(Math.floor((B+D)/E.tile_h));var v=parseInt(Math.floor((C+u)/E.tile_w));return{si:A,sj:z,ei:w,ej:v}};f.prototype.setTile=function(w,v,x){var u=this;if(u.tiles[w]===undefined){u.tiles[w]=[]}if(u.tiles[w][v]===undefined){u.tiles[w][v]=[]}u.tiles[w][v][x.layer]=x;return u};f.prototype.getTile=function(x,v,w){var u=this;if(u.tiles[x]!==undefined&&u.tiles[x][v]!==undefined&&u.tiles[x][v][w]!==undefined){return u.tiles[x][v][w]}return null};f.prototype.removeTile=function(x,v,w){var u=this;if(u.tiles[x]!==undefined&&u.tiles[x][v]!==undefined&&u.tiles[x][v][w]!==undefined){delete u.tiles[x][v][w]}};f.prototype.getFullWidth=function(){var u=this;return u.width*u.tile_w};f.prototype.getFullHeight=function(){var u=this;return u.height*u.tile_h};f.prototype.addEvent=function(v){var u=this;u.events.push(v);u._colideTree.insert(v.bounds)};f.prototype.eachTile=function(x){var u=this;for(var w=0;w<u.height;w++){for(var v=0;v<u.width;v++){if(u.tiles[w]!==undefined&&u.tiles[w][v]!==undefined){u.tiles[w][v].forEach(function(z,y){x(z,w,v,y)})}}}};var h=function(v,w){var u=this;u.width=10;u.height=10;u.x=0;u.y=0;u.parent=w};h.TOP_LEFT=0;h.TOP_CENTER=1;h.TOP_RIGHT=2;h.CENTER_LEFT=3;h.CENTER_CENTER=4;h.CENTER_RIGHT=5;h.BOTTOM_LEFT=6;h.BOTTOM_CENTER=7;h.BOTTOM_RIGHT=8;var k={loadedImages:[],loadAll:function(u,v){g(u,[],v)},load:function(x,y){var w=this;var u=document.createElement("a");u.href=x;x=$(u).prop("href");if(w.loadedImages[x]===undefined){var v=new Image();v.crossOrigin="Anonymous";v.src=x;v.onload=function(){w.loadedImages[x]=v;y(v)}}else{y(w.loadedImages[x])}},toDataURL:function(u,y){var v=document.createElement("canvas");var w=v.getContext("2d");v.width=u.width;v.height=u.height;w.drawImage(u,0,0);var x=v.toDataURL();y(x);v=null}};var g=function(u,w,x){w=w===undefined?[]:w;if(u.length>0){var v=u.shift();k.load(v,function(y){w.push(y);g(u,w,x)})}else{if(typeof x==="function"){x(w)}}};var m={fields:["image","dWidth","dHeight","sWidth","sHeight","sx","sy","dx","dy","layer"],load:function(z,A,B){var x=this;A=A===undefined||!(A instanceof f)?new f():A;var v=parseInt(z.tile_w);var y=parseInt(z.tile_h);v=isNaN(v)?32:v;y=isNaN(y)?32:y;A.tile_w=v;A.tile_h=y;var u=z.tilesets!==undefined?z.tilesets:[];var w=z.tiles!==undefined?z.tiles:[];A.colision=z.colision!==undefined?z.colision:[];k.loadAll(u,function(C){w.forEach(function(E,D){if(E!==null){E.forEach(function(F,G){if(F!==null){F.forEach(function(I,H){if(I!==null){var J={};x.fields.forEach(function(M,L){if(I[L]!==undefined){J[M]=I[L]}});if(J.image!==undefined){var K=J.image;if(C[K]!==undefined){J.image=C[K]}}A.setTile(D,G,J)}else{A.removeTile(D,G)}})}})}});B(A)})}};c.Direction=a;c.Graphic=o;c.Character=d;c.CanvasEngine=q;c.Event=t;c.Page=l;c.Map=f;c.MapLoader=m;c.Player=p;j.RPG=c})(window);